{% extends "base.html" %}

{% block title %}Detail - {{ applicant.first_name }} {{ applicant.last_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ applicant.first_name }} {{ applicant.last_name }}</h2>
    <div class="actions">
        {% if applicant.email_sent %}
        <span style="color: var(--success-color); margin-right: 1rem;">
            ‚úì Email odesl√°n {{ applicant.email_sent_at[:16] if applicant.email_sent_at else '' }}
        </span>
        {% else %}
        <button type="button" onclick="openEmailModal()" class="btn btn-success">Odeslat email s kartou</button>
        {% endif %}
        <button type="button" onclick="openDeleteModal()" class="btn btn-danger">Smazat</button>
        <button type="button" onclick="openEditModal()" class="btn btn-secondary">Upravit</button>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Zpƒõt na seznam</a>
    </div>
</div>

{% if applicant.suspect_duplicate %}
<div class="alert alert-warning"
    style="margin-bottom: 1rem; background-color: #fff3cd; color: #856404; padding: 0.75rem 1.25rem; border: 1px solid #ffeeba; border-radius: 0.25rem;">
    ‚ö†Ô∏è <strong>POZOR:</strong> Podez≈ôel√° duplicitn√≠ p≈ôihl√°≈°ka (jm√©no, p≈ô√≠jmen√≠ a e‚Äëmail se shoduj√≠).
</div>
{% endif %}

<div class="detail-card full-width" style="margin-bottom: 2rem;">
    <h3>ƒålensk√Ω pr≈Økaz</h3>
    <div style="text-align: center;">
        <img src="{{ url_for('serve_card_preview', id=applicant.id) }}" alt="N√°hled ƒçlensk√©ho pr≈Økazu"
            style="max-width: 500px; width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;"
            onclick="window.open('{{ url_for('applicant_card', id=applicant.id) }}', '_blank')">
        <p style="margin-top: 0.5rem; font-size: 0.9em; color: #666;">
            <em>Kliknƒõte na obr√°zek pro sta≈æen√≠ v pln√© kvalitƒõ</em>
        </p>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-card">
        <h3>Z√°kladn√≠ informace</h3>
        <dl>
            <dt>ƒå√≠slo karty:</dt>
            <dd><span class="badge">{{ applicant.membership_id }}</span></dd>

            <dt>Email:</dt>
            <dd><a href="mailto:{{ applicant.email }}">{{ applicant.email }}</a></dd>

            <dt>Telefon:</dt>
            <dd>{{ applicant.phone }}</dd>

            <dt>Datum narozen√≠:</dt>
            <dd>{{ applicant.dob }}</dd>

            <dt>Vƒõk:</dt>
            <dd>
                {% if applicant.age %}
                <span class="age-badge {% if applicant.age < 15 or applicant.age >= 25 %}age-warning{% endif %}">
                    {{ applicant.age }} let
                    {% if applicant.age < 15 %}(‚ö†Ô∏è Pod 15 let){% endif %} {% if applicant.age>= 25 %}(‚ö†Ô∏è Nad 24 let){%
                        endif %}
                </span>
                {% else %}
                N/A
                {% endif %}
            </dd>

            <dt>Stav:</dt>
            <dd>
                <span class="status-badge status-{{ applicant.status | slugify_status }}">
                    {{ applicant.status or 'Nov√°' }}
                </span>
            </dd>
        </dl>
    </div>

    <div class="detail-card">
        <h3>Bydli≈°tƒõ a ≈°kola</h3>
        <dl>
            <dt>Mƒõsto:</dt>
            <dd>{{ applicant.city or '-' }}</dd>

            <dt>≈†kola:</dt>
            <dd>{{ applicant.school or '-' }}</dd>
        </dl>
    </div>

    <div class="detail-card">
        <h3>Z√°jmy a preference</h3>
        <dl>
            <dt>Z√°jmy:</dt>
            <dd>{{ applicant.interests or '-' }}</dd>

            <dt>Povaha:</dt>
            <dd>{{ applicant.character or '-' }}</dd>

            <dt>Frekvence n√°v≈°tƒõv:</dt>
            <dd>{{ applicant.frequency or '-' }}</dd>

            <dt>Barva:</dt>
            <dd>{{ applicant.color or '-' }}</dd>
        </dl>
    </div>

    <div class="detail-card">
        <h3>Zdroj informac√≠</h3>
        <dl>
            <dt>Odkud o n√°s v√≠:</dt>
            <dd>{{ applicant.source or '-' }}</dd>

            <dt>Detail zdroje:</dt>
            <dd>{{ applicant.source_detail or '-' }}</dd>
        </dl>
    </div>

    {% if applicant.message %}
    <div class="detail-card full-width">
        <h3>Zpr√°va od uchazeƒçe</h3>
        <p>{{ applicant.message }}</p>
    </div>
    {% endif %}

    <div class="detail-card full-width">
        <h3>Newsletter</h3>
        <p>{{ applicant.newsletter or 'Bez odpovƒõdi' }}</p>
    </div>

    <div class="detail-card full-width">
        <h3>P≈Øvodn√≠ e-mail</h3>
        <pre class="email-body">{{ applicant.full_body }}</pre>
    </div>

    <div class="detail-card full-width">
        <h3>Metadata</h3>
        <dl>
            <dt>P≈ôihl√°≈°ka p≈ôijata:</dt>
            <dd>{{ applicant.application_received or 'Nen√≠ k dispozici (CSV import)' }}</dd>

            <dt>Datum vytvo≈ôen√≠:</dt>
            <dd>{{ applicant.created_at }}</dd>

            <dt>ID v datab√°zi:</dt>
            <dd>{{ applicant.id }}</dd>
        </dl>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">Upravit uchazeƒçe</div>
        <form id="editForm" action="{{ url_for('update_applicant', id=applicant.id) }}" method="POST">
            <div class="form-group">
                <label for="edit_first_name">Jm√©no</label>
                <input type="text" id="edit_first_name" name="first_name" value="{{ applicant.first_name }}" required
                    class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_last_name">P≈ô√≠jmen√≠</label>
                <input type="text" id="edit_last_name" name="last_name" value="{{ applicant.last_name }}" required
                    class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_email">Email</label>
                <input type="email" id="edit_email" name="email" value="{{ applicant.email }}" required
                    class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_phone">Telefon</label>
                <input type="text" id="edit_phone" name="phone" value="{{ applicant.phone }}" class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_dob">Datum narozen√≠</label>
                <input type="text" id="edit_dob" name="dob" value="{{ applicant.dob }}" placeholder="DD.MM.YYYY"
                    class="form-control">
            </div>

            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border-color);">

            <div class="form-group">
                <label for="edit_status">Stav p≈ôihl√°≈°ky</label>
                <select id="edit_status" class="form-control" onchange="updateStatus(this.value)">
                    <option value="Nov√°" {% if applicant.status=='Nov√°' %}selected{% endif %}>Nov√°</option>
                    <option value="Zpracov√°v√° se" {% if applicant.status=='Zpracov√°v√° se' %}selected{% endif %}>
                        Zpracov√°v√° se</option>
                    <option value="Vy≈ô√≠zen√°" {% if applicant.status=='Vy≈ô√≠zen√°' %}selected{% endif %}>Vy≈ô√≠zen√°</option>
                </select>
                <input type="hidden" id="status_input" name="status" value="{{ applicant.status or 'Nov√°' }}">
            </div>

            <div class="modal-actions" style="margin-top: 1.5rem;">
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Zru≈°it</button>
                <button type="submit" class="btn btn-primary">Ulo≈æit zmƒõny</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">Smazat uchazeƒçe?</div>
        <div class="modal-body">
            <p>Opravdu chcete smazat uchazeƒçe <strong>{{ applicant.first_name }} {{ applicant.last_name }}</strong>?</p>
            <p style="color: #dc3545;">Tato akce je nevratn√°.</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Zru≈°it</button>
            <form action="{{ url_for('delete_applicant', id=applicant.id) }}" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-danger">Smazat</button>
            </form>
        </div>
    </div>
</div>

<!-- Email Preview Modal -->
<div id="emailModal" class="modal-overlay">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-title">üìß N√°hled emailu</div>
        <div class="modal-body">
            <div id="emailPreviewContent">
                <p>Naƒç√≠t√°n√≠ n√°hledu...</p>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeEmailModal()">Zru≈°it</button>
            <button id="sendEmailBtn" class="btn btn-success" onclick="confirmSendEmail()">Odeslat email</button>
        </div>
    </div>
</div>

<script>
    function openEditModal() {
        const modal = document.getElementById('editModal');
        modal.style.display = 'flex';
        modal.offsetHeight; // Trigger reflow
        modal.classList.add('active');
    }

    function closeEditModal() {
        const modal = document.getElementById('editModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function updateStatus(newStatus) {
        document.getElementById('status_input').value = newStatus;
    }

    function openDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.style.display = 'flex';
        modal.offsetHeight; // Trigger reflow
        modal.classList.add('active');
    }

    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    // Close modals on click outside
    window.onclick = function (event) {
        if (event.target.classList.contains('modal-overlay')) {
            if (event.target.id === 'editModal') closeEditModal();
            if (event.target.id === 'deleteModal') closeDeleteModal();
        }
    }

    // Close on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeEditModal();
            closeDeleteModal();
            closeEmailModal();
        }
    });

    // Email Modal Functions
    async function openEmailModal() {
        const modal = document.getElementById('emailModal');
        const previewContent = document.getElementById('emailPreviewContent');

        // Show modal
        modal.style.display = 'flex';
        modal.offsetHeight;
        modal.classList.add('active');

        // Load preview
        previewContent.innerHTML = '<p>Naƒç√≠t√°n√≠ n√°hledu...</p>';

        try {
            const response = await fetch('/applicant/{{ applicant.id }}/email/preview', {
                method: 'POST'
            });

            const data = await response.json();

            if (data.error) {
                previewContent.innerHTML = `<p style="color: var(--danger-color);">Chyba: ${data.error}</p>`;
                document.getElementById('sendEmailBtn').disabled = true;
                return;
            }

            // Display preview
            const testModeWarning = data.is_test_mode ?
                `<div style="background: #fff3cd; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                    <strong>‚ö†Ô∏è TESTOVAC√ç RE≈ΩIM:</strong> Email bude odesl√°n na <code>${data.recipient}</code> m√≠sto emailu uchazeƒçe.
                </div>` : '';

            previewContent.innerHTML = `
                ${testModeWarning}
                <div style="margin-bottom: 1rem;">
                    <strong>Komu:</strong> ${data.recipient}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>P≈ôedmƒõt:</strong> ${data.subject}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Text:</strong>
                    <pre style="background: #f5f5f5; padding: 1rem; border-radius: 4px; white-space: pre-wrap; font-size: 0.9em;">${data.body}</pre>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>P≈ô√≠loha:</strong> ƒålensk√° karta (PNG)
                </div>
            `;

            document.getElementById('sendEmailBtn').disabled = false;

        } catch (error) {
            console.error('Error loading preview:', error);
            previewContent.innerHTML = '<p style="color: var(--danger-color);">Chyba p≈ôi naƒç√≠t√°n√≠ n√°hledu</p>';
            document.getElementById('sendEmailBtn').disabled = true;
        }
    }

    function closeEmailModal() {
        const modal = document.getElementById('emailModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    async function confirmSendEmail() {
        const btn = document.getElementById('sendEmailBtn');
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = 'Odes√≠l√°n√≠...';

        try {
            const response = await fetch('/applicant/{{ applicant.id }}/email/send', {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                alert(`‚úì ${result.message}`);
                closeEmailModal();
                // Reload page to show updated status
                window.location.reload();
            } else {
                alert(`‚úó Error: ${result.message || result.error}`);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } catch (error) {
            console.error('Error sending email:', error);
            alert('‚úó Chyba p≈ôi odes√≠l√°n√≠ emailu');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }
</script>
{% endblock %}