{% extends "base.html" %}

{% block title %}Detail - {{ applicant.first_name }} {{ applicant.last_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ applicant.first_name }} {{ applicant.last_name }}</h2>
</div>

<!-- Action Buttons Card -->
<div
    style="background: var(--card-bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between;">
        <!-- Primary Actions -->
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">


            <button onclick="exportToEcomail({{ applicant.id }})" class="btn btn-secondary btn-small" id="exportBtn">
                {% if applicant.exported_to_ecomail %}
                üîÑ Aktualizovat v Ecomail
                {% else %}
                üì§ Vytvo≈ôit v Ecomail
                {% endif %}
            </button>

            <button onclick="confirmWelcomeEmail({{ applicant.id }})" class="btn btn-secondary btn-small" id="emailBtn">
                {% if applicant.email_sent %}
                üìß Poslat znovu (odesl√°no {{ applicant.email_sent_at }})
                {% else %}
                üìß Poslat uv√≠tac√≠ email
                {% endif %}
            </button>

            <button type="button" onclick="openDeleteModal()" class="btn btn-danger btn-small">Smazat</button>
        </div>

        <!-- Divider for mobile/small screens -->
        <div style="display: none; width: 100%; height: 1px; background: var(--border-color); margin: 0.5rem 0;"
            class="mobile-divider"></div>

        <!-- Navigation Actions -->
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; border-left: 1px solid var(--border-color); padding-left: 1rem;"
            class="nav-actions">
            {% if prev_id %}
            <a href="{{ url_for('applicant_detail', id=prev_id, **back_args) }}" class="btn btn-secondary btn-small"
                title="P≈ôedchoz√≠">‚Üê</a>
            {% endif %}

            <a href="{{ url_for('index', **back_args) }}" class="btn btn-secondary btn-small">Zpƒõt na seznam</a>

            {% if next_id %}
            <a href="{{ url_for('applicant_detail', id=next_id, **back_args) }}" class="btn btn-secondary btn-small"
                title="N√°sleduj√≠c√≠">‚Üí</a>
            {% endif %}
        </div>
    </div>
</div>

<style>
    @media (max-width: 768px) {
        .mobile-divider {
            display: block !important;
        }

        .nav-actions {
            border-left: none !important;
            padding-left: 0 !important;
            width: 100%;
            justify-content: space-between;
        }
    }

    /* Global styles for audit log table */
    .audit-log-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
        margin-top: 1rem;
        background: #fff;
        border: 1px solid var(--border-color);
    }

    .audit-log-table th,
    .audit-log-table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        border-right: 1px solid var(--border-color);
        /* Add vertical borders */
    }

    .audit-log-table th {
        background-color: var(--bg-secondary);
        font-weight: 600;
        color: var(--text-color);
        white-space: nowrap;
    }

    .audit-log-table tr:last-child td {
        border-bottom: none;
    }

    .audit-log-table tr:hover {
        background-color: #f9f9f9;
        /* Striped hover effect */
    }

    .audit-log-table td:last-child,
    .audit-log-table th:last-child {
        border-right: none;
    }

    .audit-value-cell {
        font-family: monospace;
        font-size: 0.85em;
        white-space: pre-wrap;
        max-width: 250px;
        overflow-wrap: break-word;
        background: #fafafa;
    }
    }
</style>

<script>
    let currentEcomailId = null;
    let isEcomailUpdate = false;
    let currentEmailId = null;

    function exportToEcomail(id) {
        currentEcomailId = id;
        const btn = document.getElementById('exportBtn');
        const originalText = btn.innerHTML;
        isEcomailUpdate = originalText.includes('Aktualizovat');

        const listName = '{{ ecomail_list_name|safe }}';
        const confirmMsg = isEcomailUpdate
            ? `Opravdu chcete aktualizovat tohoto uchazeƒçe v Ecomailu (seznam ${listName})?`
            : `Opravdu chcete exportovat tohoto uchazeƒçe do Ecomailu (seznam ${listName})?`;

        document.getElementById('ecomailConfirmMsg').textContent = confirmMsg;

        const modal = document.getElementById('ecomailModal');
        modal.style.display = 'flex';
        modal.offsetHeight; // Trigger reflow
        modal.classList.add('active');
    }

    function closeEcomailModal() {
        const modal = document.getElementById('ecomailModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            currentEcomailId = null;
        }, 300);
    }

    function closeEcomailSuccessModal() {
        const modal = document.getElementById('ecomailSuccessModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            window.location.reload();
        }, 300);
    }

    async function confirmEcomailExport() {
        if (!currentEcomailId) return;

        closeEcomailModal();

        const btn = document.getElementById('exportBtn');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = isEcomailUpdate ? '‚è≥ Aktualizuji...' : '‚è≥ Exportuji...';

        try {
            const response = await fetch(`/applicant/${currentEcomailId}/export_to_ecomail`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                btn.innerHTML = 'üîÑ Aktualizovat v Ecomail';
                btn.disabled = false;
                const successMsg = isEcomailUpdate
                    ? '‚úì Uchazeƒç byl √∫spƒõ≈°nƒõ aktualizov√°n v Ecomailu.'
                    : '‚úì Uchazeƒç byl √∫spƒõ≈°nƒõ exportov√°n do Ecomailu.';

                // Show success modal
                const successModal = document.getElementById('ecomailSuccessModal');
                document.getElementById('ecomailSuccessMsg').textContent = successMsg;
                successModal.style.display = 'flex';
                successModal.offsetHeight;
                successModal.classList.add('active');
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert('Chyba p≈ôi exportu: ' + (result.error || 'Nezn√°m√° chyba'));
            }
        } catch (error) {
            console.error('Error:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert('Chyba p≈ôi komunikaci se serverem.');
        }
    }

    // Email Sending Logic
    function confirmWelcomeEmail(id) {
        currentEmailId = id;
        const confirmMsg = `Opravdu chcete poslat uv√≠tac√≠ email s ƒçlenskou kartiƒçkou na adresu {{ applicant.email }}?`;

        document.getElementById('welcomeEmailConfirmMsg').textContent = confirmMsg;

        const modal = document.getElementById('welcomeEmailModal');
        modal.style.display = 'flex';
        modal.offsetHeight;
        modal.classList.add('active');
    }

    function closeWelcomeEmailModal() {
        const modal = document.getElementById('welcomeEmailModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            currentEmailId = null;
        }, 300);
    }

    async function sendWelcomeEmail() {
        if (!currentEmailId) return;

        closeWelcomeEmailModal();

        const btn = document.getElementById('emailBtn');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '‚è≥ Odes√≠l√°m...';

        try {
            const response = await fetch(`/applicant/${currentEmailId}/send_welcome_email`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                btn.disabled = false;

                // Show success modal
                const successModal = document.getElementById('welcomeEmailSuccessModal');
                const successMsg = `‚úì Email byl √∫spƒõ≈°nƒõ odesl√°n na adresu ${result.recipient}`;
                if (result.mode === 'test') {
                    document.getElementById('welcomeEmailSuccessMsg').innerHTML = successMsg + '<br><small>(Testovac√≠ re≈æim: odesl√°no na testovac√≠ email)</small>';
                } else {
                    document.getElementById('welcomeEmailSuccessMsg').textContent = successMsg;
                }

                successModal.style.display = 'flex';
                successModal.offsetHeight;
                successModal.classList.add('active');
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert('Chyba p≈ôi odes√≠l√°n√≠: ' + (result.error || 'Nezn√°m√° chyba'));
            }
        } catch (error) {
            console.error('Error:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert('Chyba p≈ôi komunikaci se serverem.');
        }
    }

    function closeWelcomeEmailSuccessModal() {
        const modal = document.getElementById('welcomeEmailSuccessModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            window.location.reload();
        }, 300);
    }

    // Auto-save note on blur
    // Auto-save note on blur
    document.addEventListener('DOMContentLoaded', function () {
        const noteTextarea = document.getElementById('noteTextarea');
        if (noteTextarea) {
            noteTextarea.addEventListener('blur', async function () {
                const noteText = this.value;
                const statusEl = document.getElementById('noteSaveStatus');

                // Show saving indicator
                statusEl.textContent = 'Ukl√°d√°n√≠...';
                statusEl.style.color = '#666';

                console.log('Saving note for applicant {{ applicant.id }}:', noteText);

                try {
                    const formData = new FormData();
                    formData.append('note', noteText);

                    const response = await fetch('/applicant/{{ applicant.id }}/update_note', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Response status:', response.status);

                    const result = await response.json();
                    console.log('Result:', result);

                    if (result.success) {
                        statusEl.textContent = '‚úì Ulo≈æeno';
                        statusEl.style.color = 'var(--success-color)';

                        setTimeout(() => {
                            statusEl.textContent = '';
                        }, 2000);
                    } else {
                        statusEl.textContent = '‚úó Chyba: ' + (result.error || 'Nezn√°m√° chyba');
                        statusEl.style.color = 'var(--danger-color)';
                    }
                } catch (error) {
                    console.error('Error saving note:', error);
                    statusEl.textContent = '‚úó Chyba p≈ôi ukl√°d√°n√≠: ' + error.message;
                    statusEl.style.color = 'var(--danger-color)';
                }
            });
        }
    });
</script>

{% if applicant.age is none or (applicant.age < 15 or applicant.age>= 25) %}
    <div class="alert alert-warning"
        style="margin-bottom: 1rem; background-color: #fff3cd; color: #856404; padding: 0.75rem 1.25rem; border: 1px solid #ffeeba; border-radius: 0.25rem;">
        <span>
            ‚ö†Ô∏è <strong>POZOR:</strong>
            {% if applicant.age is none %}
            Neplatn√© datum narozen√≠.
            {% elif applicant.age < 15 %} Vƒõk pod 15 let ({{ applicant.age }} let). {% else %} Vƒõk nad 24 let ({{
                applicant.age }} let). {% endif %} </span>
    </div>
    {% endif %}

    {% if applicant.suspect_parent_email %}
    <div class="alert alert-warning"
        style="margin-bottom: 1rem; background-color: #fff3cd; color: #856404; padding: 0.75rem 1.25rem; border: 1px solid #ffeeba; border-radius: 0.25rem; display: flex; justify-content: space-between; align-items: center;">
        <span>‚ö†Ô∏è <strong>POZOR:</strong> Email neobsahuje jm√©no uchazeƒçe - pravdƒõpodobnƒõ email rodiƒçe nebo jin√©
            osoby.</span>
        <form action="{{ url_for('dismiss_parent_warning', id=applicant.id) }}" method="POST" style="margin: 0;">
            <button type="submit" class="btn btn-small"
                style="background: #856404; color: white; padding: 0.25rem 0.75rem; font-size: 0.85rem;">Skr√Ωt</button>
        </form>
    </div>
    {% endif %}

    {% if applicant.is_duplicate %}
    <div class="alert alert-warning"
        style="margin-bottom: 1rem; background-color: #fff3cd; color: #856404; padding: 0.75rem 1.25rem; border: 1px solid #ffeeba; border-radius: 0.25rem; display: flex; justify-content: space-between; align-items: center;">
        <span>
            ‚ö†Ô∏è <strong>POZOR:</strong> Nalezen duplicitn√≠ kontakt v datab√°zi
            {% if applicant.duplicate_details.email_duplicate %}(shodn√Ω email){% endif %}
            {% if applicant.duplicate_details.phone_duplicate %}(shodn√Ω telefon){% endif %}.
            Pravdƒõpodobnƒõ se jedn√° o opakovanou p≈ôihl√°≈°ku.
        </span>
        <form action="{{ url_for('dismiss_duplicate_warning', id=applicant.id) }}" method="POST" style="margin: 0;">
            <button type="submit" class="btn btn-small"
                style="background: #856404; color: white; padding: 0.25rem 0.75rem; font-size: 0.85rem;">Skr√Ωt</button>
        </form>
    </div>
    {% endif %}

    <div class="detail-card full-width" style="margin-bottom: 2rem;">
        <h3>ƒålensk√Ω pr≈Økaz</h3>
        <div style="text-align: center;">
            <img src="{{ url_for('serve_card_preview', id=applicant.id) }}" alt="N√°hled ƒçlensk√©ho pr≈Økazu"
                style="max-width: 500px; width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;"
                onclick="window.open('{{ url_for('applicant_card', id=applicant.id) }}', '_blank')">
            <p style="margin-top: 0.5rem; font-size: 0.9em; color: #666;">
                <em>Kliknƒõte na obr√°zek pro sta≈æen√≠ v pln√© kvalitƒõ</em>
            </p>
        </div>
    </div>

    <!-- Note Section -->
    <div class="detail-card full-width" style="margin-bottom: 2rem;">
        <h3>üìù Pozn√°mka</h3>
        <div style="margin-top: 1rem;">
            <textarea id="noteTextarea" class="form-control" rows="4"
                placeholder="Zadejte pozn√°mku k uchazeƒçi...">{{ applicant.note or '' }}</textarea>
            <span id="noteSaveStatus" style="display: inline-block; margin-top: 0.5rem; font-size: 0.9em;"></span>
        </div>
    </div>

    <div class="detail-grid">
        <div class="detail-card">
            <h3>Z√°kladn√≠ informace</h3>
            <dl>
                <dt>ƒå√≠slo karty:</dt>
                <dd><span class="badge">{{ applicant.membership_id }}</span></dd>

                <dt>Jm√©no:</dt>
                <dd>
                    <span id="display_first_name">{{ applicant.first_name }}</span>
                    <span id="input_first_name" style="display: none;">
                        <input type="text" value="{{ applicant.first_name }}"
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                    </span>
                    <button id="btn_edit_first_name" onclick="enableInlineEdit('first_name', 'first_name')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_first_name" onclick="saveInlineEdit('first_name', 'first_name')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_first_name" onclick="cancelInlineEdit('first_name')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>P≈ô√≠jmen√≠:</dt>
                <dd>
                    <span id="display_last_name">{{ applicant.last_name }}</span>
                    <span id="input_last_name" style="display: none;">
                        <input type="text" value="{{ applicant.last_name }}"
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                    </span>
                    <button id="btn_edit_last_name" onclick="enableInlineEdit('last_name', 'last_name')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_last_name" onclick="saveInlineEdit('last_name', 'last_name')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_last_name" onclick="cancelInlineEdit('last_name')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>Email:</dt>
                <dd>
                    <span id="display_email"><a href="mailto:{{ applicant.email }}">{{ applicant.email }}</a></span>
                    <span id="input_email" style="display: none;">
                        <input type="email" value="{{ applicant.email }}"
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem; min-width: 200px;">
                    </span>
                    <button id="btn_edit_email" onclick="enableInlineEdit('email', 'email')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_email" onclick="saveInlineEdit('email', 'email')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_email" onclick="cancelInlineEdit('email')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>Telefon:</dt>
                <dd>
                    <span id="display_phone">{{ applicant.phone }}</span>
                    <span id="input_phone" style="display: none;">
                        <input type="text" value="{{ applicant.phone }}"
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                    </span>
                    <button id="btn_edit_phone" onclick="enableInlineEdit('phone', 'phone')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_phone" onclick="saveInlineEdit('phone', 'phone')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_phone" onclick="cancelInlineEdit('phone')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>Datum narozen√≠:</dt>
                <dd>
                    <span id="display_dob">{{ applicant.dob }}</span>
                    <span id="input_dob" style="display: none;">
                        <input type="date" id="dob_input" value=""
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                    </span>
                    <button id="btn_edit_dob" onclick="enableInlineEdit('dob', 'dob')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_dob" onclick="saveInlineEditDOB()" class="btn btn-small btn-success"
                        style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_dob" onclick="cancelInlineEdit('dob')" class="btn btn-small btn-secondary"
                        style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>Vƒõk:</dt>
                <dd>
                    {% if applicant.age is not none %}
                    <span class="age-badge {% if applicant.age < 15 or applicant.age >= 25 %}age-warning{% endif %}">
                        {{ applicant.age }} let
                    </span>
                    {% else %}
                    <span class="age-badge age-warning">N/A</span>
                    {% endif %}
                </dd>

                <dt>Stav:</dt>
                <dd>
                    <span id="display_status">
                        <span class="status-badge status-{{ applicant.status | slugify_status }}">
                            {{ applicant.status or 'Nov√°' }}
                        </span>
                    </span>
                    <span id="input_status" style="display: none;">
                        <select
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                            <option value="Nov√°" {% if applicant.status=='Nov√°' %}selected{% endif %}>Nov√°</option>
                            <option value="Zpracov√°v√° se" {% if applicant.status=='Zpracov√°v√° se' %}selected{% endif %}>
                                Zpracov√°v√° se</option>
                            <option value="Vy≈ô√≠zen√°" {% if applicant.status=='Vy≈ô√≠zen√°' %}selected{% endif %}>Vy≈ô√≠zen√°
                            </option>
                        </select>
                    </span>
                    <button id="btn_edit_status" onclick="enableInlineEdit('status', 'status')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_status" onclick="saveInlineEdit('status', 'status')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_status" onclick="cancelInlineEdit('status')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>
            </dl>
        </div>

        <div class="detail-card">
            <h3>Bydli≈°tƒõ a ≈°kola</h3>
            <dl>
                <dt>Mƒõsto:</dt>
                <dd>{{ applicant.city or '-' }}</dd>

                <dt>≈†kola:</dt>
                <dd>{{ applicant.school or '-' }}</dd>
            </dl>
        </div>

        <div class="detail-card">
            <h3>Z√°jmy a preference</h3>
            <dl>
                <dt>Z√°jmy:</dt>
                <dd>{{ applicant.interests or '-' }}</dd>

                <dt>Povaha:</dt>
                <dd>{{ applicant.character or '-' }}</dd>

                <dt>Frekvence n√°v≈°tƒõv:</dt>
                <dd>{{ applicant.frequency or '-' }}</dd>

                <dt>Barva:</dt>
                <dd>{{ applicant.color or '-' }}</dd>
            </dl>
        </div>

        <div class="detail-card">
            <h3>Zdroj informac√≠</h3>
            <dl>
                <dt>Odkud o n√°s v√≠:</dt>
                <dd>{{ applicant.source or '-' }}</dd>

                <dt>Detail zdroje:</dt>
                <dd>{{ applicant.source_detail or '-' }}</dd>
            </dl>
        </div>

        {% if applicant.message %}
        <div class="detail-card full-width">
            <h3>Zpr√°va od uchazeƒçe</h3>
            <p>{{ applicant.message }}</p>
        </div>
        {% endif %}

        <div class="detail-card full-width">
            <h3>Newsletter</h3>
            <p>{{ 'Ano' if applicant.newsletter == 1 else 'Ne' }}</p>
        </div>

        <div class="detail-card full-width">
            <h3>P≈Øvodn√≠ e-mail</h3>
            <pre class="email-body">{{ applicant.full_body }}</pre>
        </div>

        <div class="detail-card full-width">
            <h3>Metadata</h3>
            <dl>
                <dt>P≈ôihl√°≈°ka p≈ôijata:</dt>
                <dd>{{ applicant.application_received or 'Nen√≠ k dispozici (CSV import)' }}</dd>

                <dt>Datum vytvo≈ôen√≠:</dt>
                <dd>{{ applicant.created_at }}</dd>

                <dt>ID v datab√°zi:</dt>
                <dd>{{ applicant.id }}</dd>
            </dl>
        </div>
    </div>


    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">Smazat uchazeƒçe?</div>
            <div class="modal-body">
                <p>Opravdu chcete smazat uchazeƒçe <strong>{{ applicant.first_name }} {{ applicant.last_name }}</strong>?
                </p>
                <p style="color: #dc3545;">Tato akce je nevratn√°.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Zru≈°it</button>
                <form action="{{ url_for('delete_applicant', id=applicant.id) }}" method="POST"
                    style="display: inline;">
                    <button type="submit" class="btn btn-danger">Smazat</button>
                </form>
            </div>
        </div>
    </div>

    {% if audit_logs %}
    <div class="detail-card full-width">
        <h3>Historie aktivit</h3>
        <div style="overflow-x: auto;">
            <table class="audit-log-table">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>U≈æivatel</th>
                        <th>Akce</th>
                        <th>P≈Øvodn√≠ hodnota</th>
                        <th>Nov√° hodnota</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in audit_logs %}
                    <tr>
                        <td>{{ log.timestamp | datetime_cz }}</td>
                        <td>{{ log.user }}</td>
                        <td>{{ log.action }}</td>
                        <td class="audit-value-cell">{{ log.old_value if log.old_value else '-' }}</td>
                        <td class="audit-value-cell">{{ log.new_value if log.new_value else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% endblock %}

    {% block scripts %}
    <script>
        // Inline Editing Logic
        function enableInlineEdit(elementId, fieldName) {
            const displayEl = document.getElementById(`display_${elementId}`);
            const inputEl = document.getElementById(`input_${elementId}`);
            const editBtn = document.getElementById(`btn_edit_${elementId}`);
            const saveBtn = document.getElementById(`btn_save_${elementId}`);
            const cancelBtn = document.getElementById(`btn_cancel_${elementId}`);

            displayEl.style.display = 'none';
            inputEl.style.display = 'inline-block';
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';

            // Focus input
            const input = inputEl.querySelector('input, select');

            // Special handling for DOB - convert DD.MM.YYYY to YYYY-MM-DD
            if (elementId === 'dob' && input) {
                const dobText = displayEl.textContent.trim();
                if (dobText && dobText.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                    const [day, month, year] = dobText.split('.');
                    input.value = `${year}-${month}-${day}`;
                }
            }

            if (input) input.focus();
        }

        function cancelInlineEdit(elementId) {
            const displayEl = document.getElementById(`display_${elementId}`);
            const inputEl = document.getElementById(`input_${elementId}`);
            const editBtn = document.getElementById(`btn_edit_${elementId}`);
            const saveBtn = document.getElementById(`btn_save_${elementId}`);
            const cancelBtn = document.getElementById(`btn_cancel_${elementId}`);

            displayEl.style.display = 'inline-block';
            inputEl.style.display = 'none';
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';

            // Reset value
            const input = inputEl.querySelector('input, select');
            // We don't easily have the original value here unless we store it. 
            // But since we didn't save, the page reload or just hiding input is fine.
            // Ideally we should reset input.value to displayEl.innerText (trimmed)
        }

        async function saveInlineEdit(elementId, fieldName) {
            const inputEl = document.getElementById(`input_${elementId}`);
            const input = inputEl.querySelector('input, select');
            const newValue = input.value;

            try {
                const response = await fetch(`/applicant/{{ applicant.id }}/update_field`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        field: fieldName,
                        value: newValue
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Reload to show updated data (and re-calculate things like age/status styles)
                    window.location.reload();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error updating field:', error);
                alert('Error updating field');
            }
        }

        async function saveInlineEditDOB() {
            const inputEl = document.getElementById('input_dob');
            const input = inputEl.querySelector('input');
            const dateValue = input.value; // YYYY-MM-DD format

            if (!dateValue) {
                alert('Pros√≠m vyberte datum');
                return;
            }

            // Convert YYYY-MM-DD to DD.MM.YYYY
            const [year, month, day] = dateValue.split('-');
            const formattedDate = `${day}.${month}.${year}`;

            try {
                const response = await fetch(`/applicant/{{ applicant.id }}/update_field`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        field: 'dob',
                        value: formattedDate
                    })
                });

                const result = await response.json();

                if (result.success) {
                    window.location.reload();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error updating field:', error);
                alert('Error updating field');
            }
        }

        function openDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.style.display = 'flex';
            modal.offsetHeight; // Trigger reflow
            modal.classList.add('active');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Close modals on click outside
        window.onclick = function (event) {
            const deleteModal = document.getElementById('deleteModal');

            const ecomailModal = document.getElementById('ecomailModal');

            if (event.target == deleteModal) {
                closeDeleteModal();
            }

            if (event.target == ecomailModal) {
                closeEcomailModal();
            }
        }

        // Close modals on Escape key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeDeleteModal();

                closeEcomailModal();
            }
        });


        // Email Sending Logic
        function confirmWelcomeEmail(id) {
            currentEmailId = id;
            const currentMode = '{{ current_mode }}';
            let confirmMsg = '';

            if (currentMode === 'test') {
                confirmMsg = `‚ö†Ô∏è <strong>TEST MODE:</strong> Email bude odesl√°n na: <strong>u7745030724@gmail.com</strong><br><small>(P≈Øvodn√≠ email: {{ applicant.email }})</small>`;
            } else {
                confirmMsg = `Opravdu chcete poslat uv√≠tac√≠ email s ƒçlenskou kartiƒçkou na adresu <strong>{{ applicant.email }}</strong>?`;
            }

            document.getElementById('welcomeEmailConfirmMsg').innerHTML = confirmMsg;

            const modal = document.getElementById('welcomeEmailModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('active');
        }

        function closeWelcomeEmailModal() {
            const modal = document.getElementById('welcomeEmailModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                currentEmailId = null;
            }, 300);
        }

        async function sendWelcomeEmail() {
            if (!currentEmailId) return;

            closeWelcomeEmailModal();

            const btn = document.getElementById('emailBtn');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Odes√≠l√°m...';

            try {
                const response = await fetch(`/applicant/${currentEmailId}/send_welcome_email`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    btn.disabled = false;

                    // Show success modal
                    const successModal = document.getElementById('welcomeEmailSuccessModal');
                    const successMsg = `‚úì Email byl √∫spƒõ≈°nƒõ odesl√°n na adresu ${result.recipient}`;
                    if (result.mode === 'test') {
                        document.getElementById('welcomeEmailSuccessMsg').innerHTML = successMsg + '<br><small>(Testovac√≠ re≈æim: odesl√°no na testovac√≠ email)</small>';
                    } else {
                        document.getElementById('welcomeEmailSuccessMsg').textContent = successMsg;
                    }

                    successModal.style.display = 'flex';
                    successModal.offsetHeight;
                    successModal.classList.add('active');
                } else {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    alert('Chyba p≈ôi odes√≠l√°n√≠: ' + (result.error || 'Nezn√°m√° chyba'));
                }
            } catch (error) {
                console.error('Error:', error);
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert('Chyba p≈ôi komunikaci se serverem.');
            }
        }

        function closeWelcomeEmailSuccessModal() {
            const modal = document.getElementById('welcomeEmailSuccessModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                window.location.reload();
            }, 300);
        }

    </script>
    <!-- Ecomail Confirmation Modal -->
    <div id="ecomailModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">Potvrzen√≠ exportu do Ecomailu</div>
            <div class="modal-body">
                <p id="ecomailConfirmMsg"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEcomailModal()">Zru≈°it</button>
                <button class="btn btn-primary" onclick="confirmEcomailExport()">Potvrdit</button>
            </div>
        </div>
    </div>

    <!-- Ecomail Success Modal -->
    <div id="ecomailSuccessModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">√öspƒõch</div>
            <div class="modal-body">
                <p id="ecomailSuccessMsg" style="color: var(--success-color); font-weight: 500;"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeEcomailSuccessModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Welcome Email Confirmation Modal -->
    <div id="welcomeEmailModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">Potvrzen√≠ odesl√°n√≠ emailu</div>
            <div class="modal-body">
                <p id="welcomeEmailConfirmMsg"></p>
                <p><small style="color: #666;">Budou pou≈æity √∫daje z datab√°ze a vygenerov√°na ƒçlensk√° karta.</small></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeWelcomeEmailModal()">Zru≈°it</button>
                <button class="btn btn-primary" onclick="sendWelcomeEmail()">Odeslat</button>
            </div>
        </div>
    </div>

    <!-- Welcome Email Success Modal -->
    <div id="welcomeEmailSuccessModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">Email odesl√°n</div>
            <div class="modal-body">
                <p id="welcomeEmailSuccessMsg" style="color: var(--success-color); font-weight: 500;"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeWelcomeEmailSuccessModal()">OK</button>
            </div>
        </div>
    </div>

    {% endblock %}