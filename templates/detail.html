{% extends "base.html" %}

{% block title %}Detail - {{ applicant.first_name }} {{ applicant.last_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ applicant.first_name }} {{ applicant.last_name }}</h2>
    <div class="actions" style="display: flex; gap: 2rem; align-items: center;">
        <div style="display: flex; gap: 0.5rem;">
            {% if applicant.email_sent %}
            <span style="color: var(--success-color); margin-right: 1rem; display: flex; align-items: center;">
                ‚úì Email odesl√°n {{ applicant.email_sent_at[:16] if applicant.email_sent_at else '' }}
            </span>
            {% else %}
            <button type="button" onclick="openEmailModal()" class="btn btn-success">Odeslat email s kartou</button>
            {% endif %}
            <button type="button" onclick="openDeleteModal()" class="btn btn-danger">Smazat</button>
        </div>

        <div style="display: flex; gap: 0.5rem; padding-left: 2rem; border-left: 2px solid var(--border-color);">
            {% if prev_id %}
            <a href="{{ url_for('applicant_detail', id=prev_id, **back_args) }}" class="btn btn-secondary">‚Üê
                P≈ôedchoz√≠</a>
            {% endif %}
            {% if next_id %}
            <a href="{{ url_for('applicant_detail', id=next_id, **back_args) }}" class="btn btn-secondary">N√°sleduj√≠c√≠
                ‚Üí</a>
            {% endif %}
            <a href="{{ url_for('index', **back_args) }}" class="btn btn-secondary">Zpƒõt na seznam</a>
        </div>
    </div>
</div>

{% if applicant.age is none or (applicant.age < 15 or applicant.age>= 25) %}
    <div class="alert alert-warning"
        style="margin-bottom: 1rem; background-color: #fff3cd; color: #856404; padding: 0.75rem 1.25rem; border: 1px solid #ffeeba; border-radius: 0.25rem;">
        <span>
            ‚ö†Ô∏è <strong>POZOR:</strong>
            {% if applicant.age is none %}
            Neplatn√© datum narozen√≠.
            {% elif applicant.age < 15 %} Vƒõk pod 15 let ({{ applicant.age }} let). {% else %} Vƒõk nad 24 let ({{
                applicant.age }} let). {% endif %} </span>
    </div>
    {% endif %}

    {% if applicant.suspect_parent_email %}
    <div class="alert alert-warning"
        style="margin-bottom: 1rem; background-color: #fff3cd; color: #856404; padding: 0.75rem 1.25rem; border: 1px solid #ffeeba; border-radius: 0.25rem; display: flex; justify-content: space-between; align-items: center;">
        <span>‚ö†Ô∏è <strong>POZOR:</strong> Email neobsahuje jm√©no uchazeƒçe - pravdƒõpodobnƒõ email rodiƒçe nebo jin√©
            osoby.</span>
        <form action="{{ url_for('dismiss_parent_warning', id=applicant.id) }}" method="POST" style="margin: 0;">
            <button type="submit" class="btn btn-small"
                style="background: #856404; color: white; padding: 0.25rem 0.75rem; font-size: 0.85rem;">Skr√Ωt</button>
        </form>
    </div>
    {% endif %}

    {% if applicant.is_duplicate %}
    <div class="alert alert-warning"
        style="margin-bottom: 1rem; background-color: #fff3cd; color: #856404; padding: 0.75rem 1.25rem; border: 1px solid #ffeeba; border-radius: 0.25rem; display: flex; justify-content: space-between; align-items: center;">
        <span>
            ‚ö†Ô∏è <strong>POZOR:</strong> Nalezen duplicitn√≠ kontakt v datab√°zi
            {% if applicant.duplicate_details.email_duplicate %}(shodn√Ω email){% endif %}
            {% if applicant.duplicate_details.phone_duplicate %}(shodn√Ω telefon){% endif %}.
            Pravdƒõpodobnƒõ se jedn√° o opakovanou p≈ôihl√°≈°ku.
        </span>
        <form action="{{ url_for('dismiss_duplicate_warning', id=applicant.id) }}" method="POST" style="margin: 0;">
            <button type="submit" class="btn btn-small"
                style="background: #856404; color: white; padding: 0.25rem 0.75rem; font-size: 0.85rem;">Skr√Ωt</button>
        </form>
    </div>
    {% endif %}

    <div class="detail-card full-width" style="margin-bottom: 2rem;">
        <h3>ƒålensk√Ω pr≈Økaz</h3>
        <div style="text-align: center;">
            <img src="{{ url_for('serve_card_preview', id=applicant.id) }}" alt="N√°hled ƒçlensk√©ho pr≈Økazu"
                style="max-width: 500px; width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;"
                onclick="window.open('{{ url_for('applicant_card', id=applicant.id) }}', '_blank')">
            <p style="margin-top: 0.5rem; font-size: 0.9em; color: #666;">
                <em>Kliknƒõte na obr√°zek pro sta≈æen√≠ v pln√© kvalitƒõ</em>
            </p>
        </div>
    </div>

    <div class="detail-grid">
        <div class="detail-card">
            <h3>Z√°kladn√≠ informace</h3>
            <dl>
                <dt>ƒå√≠slo karty:</dt>
                <dd><span class="badge">{{ applicant.membership_id }}</span></dd>

                <dt>Jm√©no:</dt>
                <dd>
                    <span id="display_first_name">{{ applicant.first_name }}</span>
                    <span id="input_first_name" style="display: none;">
                        <input type="text" value="{{ applicant.first_name }}"
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                    </span>
                    <button id="btn_edit_first_name" onclick="enableInlineEdit('first_name', 'first_name')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_first_name" onclick="saveInlineEdit('first_name', 'first_name')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_first_name" onclick="cancelInlineEdit('first_name')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>P≈ô√≠jmen√≠:</dt>
                <dd>
                    <span id="display_last_name">{{ applicant.last_name }}</span>
                    <span id="input_last_name" style="display: none;">
                        <input type="text" value="{{ applicant.last_name }}"
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                    </span>
                    <button id="btn_edit_last_name" onclick="enableInlineEdit('last_name', 'last_name')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_last_name" onclick="saveInlineEdit('last_name', 'last_name')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_last_name" onclick="cancelInlineEdit('last_name')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>Email:</dt>
                <dd>
                    <span id="display_email"><a href="mailto:{{ applicant.email }}">{{ applicant.email }}</a></span>
                    <span id="input_email" style="display: none;">
                        <input type="email" value="{{ applicant.email }}"
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem; min-width: 200px;">
                    </span>
                    <button id="btn_edit_email" onclick="enableInlineEdit('email', 'email')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_email" onclick="saveInlineEdit('email', 'email')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_email" onclick="cancelInlineEdit('email')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>Telefon:</dt>
                <dd>
                    <span id="display_phone">{{ applicant.phone }}</span>
                    <span id="input_phone" style="display: none;">
                        <input type="text" value="{{ applicant.phone }}"
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                    </span>
                    <button id="btn_edit_phone" onclick="enableInlineEdit('phone', 'phone')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_phone" onclick="saveInlineEdit('phone', 'phone')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_phone" onclick="cancelInlineEdit('phone')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>Datum narozen√≠:</dt>
                <dd>
                    <span id="display_dob">{{ applicant.dob }}</span>
                    <span id="input_dob" style="display: none;">
                        <input type="date" id="dob_input" value=""
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                    </span>
                    <button id="btn_edit_dob" onclick="enableInlineEdit('dob', 'dob')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_dob" onclick="saveInlineEditDOB()" class="btn btn-small btn-success"
                        style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_dob" onclick="cancelInlineEdit('dob')" class="btn btn-small btn-secondary"
                        style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>

                <dt>Vƒõk:</dt>
                <dd>
                    {% if applicant.age is not none %}
                    <span class="age-badge {% if applicant.age < 15 or applicant.age >= 25 %}age-warning{% endif %}">
                        {{ applicant.age }} let
                    </span>
                    {% else %}
                    <span class="age-badge age-warning">N/A</span>
                    {% endif %}
                </dd>

                <dt>Stav:</dt>
                <dd>
                    <span id="display_status">
                        <span class="status-badge status-{{ applicant.status | slugify_status }}">
                            {{ applicant.status or 'Nov√°' }}
                        </span>
                    </span>
                    <span id="input_status" style="display: none;">
                        <select
                            style="padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem;">
                            <option value="Nov√°" {% if applicant.status=='Nov√°' %}selected{% endif %}>Nov√°</option>
                            <option value="Zpracov√°v√° se" {% if applicant.status=='Zpracov√°v√° se' %}selected{% endif %}>
                                Zpracov√°v√° se</option>
                            <option value="Vy≈ô√≠zen√°" {% if applicant.status=='Vy≈ô√≠zen√°' %}selected{% endif %}>Vy≈ô√≠zen√°
                            </option>
                        </select>
                    </span>
                    <button id="btn_edit_status" onclick="enableInlineEdit('status', 'status')"
                        style="border: none; background: none; cursor: pointer; margin-left: 0.5rem; opacity: 0.6;"
                        title="Upravit">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button id="btn_save_status" onclick="saveInlineEdit('status', 'status')"
                        class="btn btn-small btn-success" style="display: none; margin-left: 0.5rem;">‚úì</button>
                    <button id="btn_cancel_status" onclick="cancelInlineEdit('status')"
                        class="btn btn-small btn-secondary" style="display: none; margin-left: 0.25rem;">‚úó</button>
                </dd>
            </dl>
        </div>

        <div class="detail-card">
            <h3>Bydli≈°tƒõ a ≈°kola</h3>
            <dl>
                <dt>Mƒõsto:</dt>
                <dd>{{ applicant.city or '-' }}</dd>

                <dt>≈†kola:</dt>
                <dd>{{ applicant.school or '-' }}</dd>
            </dl>
        </div>

        <div class="detail-card">
            <h3>Z√°jmy a preference</h3>
            <dl>
                <dt>Z√°jmy:</dt>
                <dd>{{ applicant.interests or '-' }}</dd>

                <dt>Povaha:</dt>
                <dd>{{ applicant.character or '-' }}</dd>

                <dt>Frekvence n√°v≈°tƒõv:</dt>
                <dd>{{ applicant.frequency or '-' }}</dd>

                <dt>Barva:</dt>
                <dd>{{ applicant.color or '-' }}</dd>
            </dl>
        </div>

        <div class="detail-card">
            <h3>Zdroj informac√≠</h3>
            <dl>
                <dt>Odkud o n√°s v√≠:</dt>
                <dd>{{ applicant.source or '-' }}</dd>

                <dt>Detail zdroje:</dt>
                <dd>{{ applicant.source_detail or '-' }}</dd>
            </dl>
        </div>

        {% if applicant.message %}
        <div class="detail-card full-width">
            <h3>Zpr√°va od uchazeƒçe</h3>
            <p>{{ applicant.message }}</p>
        </div>
        {% endif %}

        <div class="detail-card full-width">
            <h3>Newsletter</h3>
            <p>{{ applicant.newsletter or 'Bez odpovƒõdi' }}</p>
        </div>

        <div class="detail-card full-width">
            <h3>P≈Øvodn√≠ e-mail</h3>
            <pre class="email-body">{{ applicant.full_body }}</pre>
        </div>

        <div class="detail-card full-width">
            <h3>Metadata</h3>
            <dl>
                <dt>P≈ôihl√°≈°ka p≈ôijata:</dt>
                <dd>{{ applicant.application_received or 'Nen√≠ k dispozici (CSV import)' }}</dd>

                <dt>Datum vytvo≈ôen√≠:</dt>
                <dd>{{ applicant.created_at }}</dd>

                <dt>ID v datab√°zi:</dt>
                <dd>{{ applicant.id }}</dd>
            </dl>
        </div>
    </div>


    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">Smazat uchazeƒçe?</div>
            <div class="modal-body">
                <p>Opravdu chcete smazat uchazeƒçe <strong>{{ applicant.first_name }} {{ applicant.last_name }}</strong>?
                </p>
                <p style="color: #dc3545;">Tato akce je nevratn√°.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Zru≈°it</button>
                <form action="{{ url_for('delete_applicant', id=applicant.id) }}" method="POST"
                    style="display: inline;">
                    <button type="submit" class="btn btn-danger">Smazat</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Email Preview Modal -->
    <div id="emailModal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-title">üìß N√°hled emailu</div>
            <div class="modal-body">
                <div id="emailPreviewContent">
                    <p>Naƒç√≠t√°n√≠ n√°hledu...</p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEmailModal()">Zru≈°it</button>
                <button id="sendEmailBtn" class="btn btn-success" onclick="confirmSendEmail()">Odeslat email</button>
            </div>
        </div>
    </div>

    {% endblock %}

    {% block scripts %}
    <script>
        // Inline Editing Logic
        function enableInlineEdit(elementId, fieldName) {
            const displayEl = document.getElementById(`display_${elementId}`);
            const inputEl = document.getElementById(`input_${elementId}`);
            const editBtn = document.getElementById(`btn_edit_${elementId}`);
            const saveBtn = document.getElementById(`btn_save_${elementId}`);
            const cancelBtn = document.getElementById(`btn_cancel_${elementId}`);

            displayEl.style.display = 'none';
            inputEl.style.display = 'inline-block';
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';

            // Focus input
            const input = inputEl.querySelector('input, select');

            // Special handling for DOB - convert DD.MM.YYYY to YYYY-MM-DD
            if (elementId === 'dob' && input) {
                const dobText = displayEl.textContent.trim();
                if (dobText && dobText.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                    const [day, month, year] = dobText.split('.');
                    input.value = `${year}-${month}-${day}`;
                }
            }

            if (input) input.focus();
        }

        function cancelInlineEdit(elementId) {
            const displayEl = document.getElementById(`display_${elementId}`);
            const inputEl = document.getElementById(`input_${elementId}`);
            const editBtn = document.getElementById(`btn_edit_${elementId}`);
            const saveBtn = document.getElementById(`btn_save_${elementId}`);
            const cancelBtn = document.getElementById(`btn_cancel_${elementId}`);

            displayEl.style.display = 'inline-block';
            inputEl.style.display = 'none';
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';

            // Reset value
            const input = inputEl.querySelector('input, select');
            // We don't easily have the original value here unless we store it. 
            // But since we didn't save, the page reload or just hiding input is fine.
            // Ideally we should reset input.value to displayEl.innerText (trimmed)
        }

        async function saveInlineEdit(elementId, fieldName) {
            const inputEl = document.getElementById(`input_${elementId}`);
            const input = inputEl.querySelector('input, select');
            const newValue = input.value;

            try {
                const response = await fetch(`/applicant/{{ applicant.id }}/update_field`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        field: fieldName,
                        value: newValue
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Reload to show updated data (and re-calculate things like age/status styles)
                    window.location.reload();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error updating field:', error);
                alert('Error updating field');
            }
        }

        async function saveInlineEditDOB() {
            const inputEl = document.getElementById('input_dob');
            const input = inputEl.querySelector('input');
            const dateValue = input.value; // YYYY-MM-DD format

            if (!dateValue) {
                alert('Pros√≠m vyberte datum');
                return;
            }

            // Convert YYYY-MM-DD to DD.MM.YYYY
            const [year, month, day] = dateValue.split('-');
            const formattedDate = `${day}.${month}.${year}`;

            try {
                const response = await fetch(`/applicant/{{ applicant.id }}/update_field`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        field: 'dob',
                        value: formattedDate
                    })
                });

                const result = await response.json();

                if (result.success) {
                    window.location.reload();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error updating field:', error);
                alert('Error updating field');
            }
        }

        function openDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.style.display = 'flex';
            modal.offsetHeight; // Trigger reflow
            modal.classList.add('active');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Close modals on click outside
        window.onclick = function (event) {
            if (event.target.classList.contains('modal-overlay')) {
                if (event.target.id === 'deleteModal') closeDeleteModal();
                if (event.target.id === 'emailModal') closeEmailModal();
            }
        }

        // Close on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeDeleteModal();
                closeEmailModal();
            }
        });

        // Email Modal Functions
        async function openEmailModal() {
            const modal = document.getElementById('emailModal');
            const previewContent = document.getElementById('emailPreviewContent');

            // Show modal
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('active');

            // Load preview
            previewContent.innerHTML = '<p>Naƒç√≠t√°n√≠ n√°hledu...</p>';

            try {
                const response = await fetch('/applicant/{{ applicant.id }}/email/preview', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.error) {
                    previewContent.innerHTML = `<p style="color: var(--danger-color);">Chyba: ${data.error}</p>`;
                    document.getElementById('sendEmailBtn').disabled = true;
                    return;
                }

                // Display preview
                const testModeWarning = data.is_test_mode ?
                    `<div style="background: #fff3cd; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                    <strong>‚ö†Ô∏è TESTOVAC√ç RE≈ΩIM:</strong> Email bude odesl√°n na <code>${data.recipient}</code> m√≠sto emailu uchazeƒçe.
                </div>` : '';

                previewContent.innerHTML = `
                ${testModeWarning}
                <div style="margin-bottom: 1rem;">
                    <strong>Komu:</strong> ${data.recipient}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>P≈ôedmƒõt:</strong> ${data.subject}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Text:</strong>
                    <pre style="background: #f5f5f5; padding: 1rem; border-radius: 4px; white-space: pre-wrap; font-size: 0.9em;">${data.body}</pre>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>P≈ô√≠loha:</strong> ƒålensk√° karta (PNG)
                </div>
            `;

                document.getElementById('sendEmailBtn').disabled = false;

            } catch (error) {
                console.error('Error loading preview:', error);
                previewContent.innerHTML = '<p style="color: var(--danger-color);">Chyba p≈ôi naƒç√≠t√°n√≠ n√°hledu</p>';
                document.getElementById('sendEmailBtn').disabled = true;
            }
        }

        function closeEmailModal() {
            const modal = document.getElementById('emailModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        async function confirmSendEmail() {
            const btn = document.getElementById('sendEmailBtn');
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.textContent = 'Odes√≠l√°n√≠...';

            try {
                const response = await fetch('/applicant/{{ applicant.id }}/email/send', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úì ${result.message}`);
                    closeEmailModal();
                    // Reload page to show updated status
                    window.location.reload();
                } else {
                    alert(`‚úó Error: ${result.message || result.error}`);
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error sending email:', error);
                alert('‚úó Chyba p≈ôi odes√≠l√°n√≠ emailu');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    </script>
    {% endblock %}