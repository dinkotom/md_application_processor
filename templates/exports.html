{% extends "base.html" %}

{% block title %}Exporty - Mlad√Ω div√°k{% endblock %}

{% block content %}
<div class="stats-header">
    <h2>üì¶ Exporty</h2>
    <p class="subtitle">Export p≈ôihl√°≈°ek do r≈Øzn√Ωch form√°t≈Ø</p>
</div>

<div class="stats-grid">
    <!-- CSV Export Section -->
    <div class="stat-card">
        <h3>üìÑ Export do CSV</h3>
        <p style="color: #666; margin-bottom: 1.5rem;">Exportujte p≈ôihl√°≈°ky do CSV souboru pro dal≈°√≠ zpracov√°n√≠.</p>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Filtrovat podle statusu:</label>
            <select id="exportStatus" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">V≈°echny p≈ôihl√°≈°ky</option>
                <option value="Nov√°">Nov√°</option>
                <option value="Schv√°len√°">Schv√°len√°</option>
                <option value="Zam√≠tnut√°">Zam√≠tnut√°</option>
                <option value="N√°hradn√≠k">N√°hradn√≠k</option>
            </select>
        </div>

        <button onclick="exportToCSV()" class="btn btn-primary" style="width: 100%;">
            üíæ St√°hnout CSV
        </button>
    </div>

    <!-- Ecomail Export Section -->
    <div class="stat-card">
        <h3>üìß Hromadn√Ω export do Ecomail</h3>
        <p style="color: #666; margin-bottom: 1.5rem;">Exportujte v√≠ce uchazeƒç≈Ø najednou do Ecomailu.</p>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Vyberte c√≠lov√Ω seznam:</label>
            <select id="ecomailListId"
                style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Naƒç√≠t√°m seznamy...</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Filtrovat podle statusu:</label>
            <select id="ecomailExportStatus"
                style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">V≈°echny p≈ôihl√°≈°ky</option>
                <option value="Schv√°len√°">Pouze schv√°len√©</option>
                <option value="Nov√°">Pouze nov√©</option>
                <option value="N√°hradn√≠k">Pouze n√°hradn√≠ky</option>
            </select>
        </div>

        <div
            style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; border-left: 3px solid #2196f3;">
            <p style="margin: 0; color: #1565c0; font-size: 0.9em;">
                ‚ÑπÔ∏è <strong>Pozn√°mka:</strong> Export <strong>nikdy nezmƒõn√≠</strong> stav odbƒõru
                (subscribed/unsubscribed) existuj√≠c√≠ch kontakt≈Ø.
            </p>
        </div>

        <button onclick="bulkExportToEcomail()" class="btn btn-primary" style="width: 100%;" id="bulkExportBtn">
            üì§ Exportovat do Ecomail
        </button>
    </div>
</div>

<style>
    .stats-header {
        margin-bottom: 2rem;
    }

    .stats-header h2 {
        margin: 0 0 0.5rem 0;
        color: #333;
    }

    .subtitle {
        color: #666;
        margin: 0;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-card h3 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.2em;
    }
</style>

<script>
    // Load Ecomail lists on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadEcomailLists();
    });

    async function loadEcomailLists() {
        try {
            const response = await fetch('/exports/ecomail/lists');
            const data = await response.json();

            const select = document.getElementById('ecomailListId');
            select.innerHTML = '';

            if (data.success && data.lists && data.lists.length > 0) {
                data.lists.forEach(list => {
                    const option = document.createElement('option');
                    option.value = list.id;
                    option.textContent = `${list.name} (${list.subscriber_count || 0} kontakt≈Ø)`;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">Nelze naƒç√≠st seznamy</option>';
                console.error('Failed to load Ecomail lists:', data.error);
            }
        } catch (error) {
            console.error('Error loading Ecomail lists:', error);
            const select = document.getElementById('ecomailListId');
            select.innerHTML = '<option value="">Chyba naƒç√≠t√°n√≠ seznam≈Ø</option>';
        }
    }

    async function bulkExportToEcomail() {
        const listId = document.getElementById('ecomailListId').value;
        const status = document.getElementById('ecomailExportStatus').value;
        const btn = document.getElementById('bulkExportBtn');

        if (!listId) {
            alert('Pros√≠m vyberte c√≠lov√Ω seznam v Ecomailu.');
            return;
        }

        // Confirm action
        const listName = document.getElementById('ecomailListId').selectedOptions[0].textContent;
        const statusText = status || 'v≈°echny p≈ôihl√°≈°ky';
        const confirmMsg = `Opravdu chcete exportovat ${statusText} do seznamu "${listName}"?\n\nStav odbƒõru existuj√≠c√≠ch kontakt≈Ø z≈Østane zachov√°n.`;

        if (!confirm(confirmMsg)) {
            return;
        }

        // Disable button and show loading state
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Exportuji...';

        try {
            const response = await fetch('/exports/ecomail/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    list_id: parseInt(listId),
                    status_filter: status
                })
            });

            const result = await response.json();

            if (result.success) {
                alert(`‚úì Export √∫spƒõ≈°n√Ω!\n\nNov√© kontakty: ${result.created}\nAktualizovan√© kontakty: ${result.updated}\nChyby: ${result.errors}`);
                btn.innerHTML = 'üì§ Exportovat do Ecomail';
            } else {
                alert(`‚úó Chyba p≈ôi exportu: ${result.error}`);
                btn.innerHTML = 'üì§ Exportovat do Ecomail';
            }
        } catch (error) {
            console.error('Error during bulk export:', error);
            alert('‚úó Neoƒçek√°van√° chyba p≈ôi exportu.');
            btn.innerHTML = 'üì§ Exportovat do Ecomail';
        } finally {
            btn.disabled = false;
        }
    }

    function exportToCSV() {
        const status = document.getElementById('exportStatus').value;
        let url = '/export/csv';
        if (status) {
            url += `?status=${encodeURIComponent(status)}`;
        }
        window.location.href = url;
    }
</script>

{% endblock %}