{% extends "base.html" %}

{% block title %}Exporty - Mlad칳 div치k{% endblock %}

{% block content %}


<div class="stats-grid">
    <!-- Excel Export Section -->
    <div class="stat-card" style="grid-column: span 3;">
        <h3>游늵 Export do Excelu</h3>
        <p style="color: #666; margin-bottom: 1.5rem;">P콏et치hn캩te pole z nab칤dky do v칳b캩ru a ur캜ete jejich po콏ad칤 v
            Excelu.</p>

        <form action="{{ url_for('export_excel') }}" method="POST" id="excelExportForm" onsubmit="prepareExportForm()">
            <div class="dnd-container">
                <!-- Left Column: Available Fields -->
                <div class="dnd-column">
                    <h4>Dostupn치 pole</h4>
                    <div id="availableFields" class="dnd-list" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <!-- Initial available fields (those NOT checked by default in previous version) -->
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="interests">Z치jmy
                        </div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="character">Povaha
                        </div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="frequency">
                            Frekvence</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="color">Barva</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="source">Zdroj</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="source_detail">
                            Detail zdroje</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="message">Vzkaz
                        </div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="newsletter">
                            Newsletter</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="id">ID</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="created_at">
                            Vytvo콏eno</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)"
                            data-value="application_received">P콏ihl치코ka p콏ijata</div>
                    </div>
                </div>

                <!-- Right Column: Selected Fields -->
                <div class="dnd-column">
                    <h4>Vybran치 pole (v tomto po콏ad칤)</h4>
                    <div id="selectedFields" class="dnd-list selected-list" ondrop="drop(event)"
                        ondragover="allowDrop(event)">
                        <!-- Initial selected fields -->
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="first_name">Jm칠no
                        </div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="last_name">P콏칤jmen칤
                        </div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="email">Email</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="phone">Telefon
                        </div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="dob">Datum narozen칤
                        </div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="guessed_gender">
                            Pohlav칤 (odhad)</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="city">M캩sto</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="school">맒ola</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="membership_id">
                            캛lensk칠 캜칤slo</div>
                        <div class="dnd-item" draggable="true" ondragstart="drag(event)" data-value="status">Status
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden inputs container -->
            <div id="formInputs"></div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">
                游 St치hnout Excel
            </button>
        </form>
    </div>
</div>

<style>
    .stats-header {
        margin-bottom: 2rem;
    }

    .stats-header h2 {
        margin: 0 0 0.5rem 0;
        color: #333;
    }

    .subtitle {
        color: #666;
        margin: 0;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Drag and Drop Styles */
    .dnd-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        min-height: 400px;
    }

    .dnd-column {
        display: flex;
        flex-direction: column;
    }

    .dnd-column h4 {
        margin: 0 0 0.5rem 0;
        color: #555;
        font-size: 0.95rem;
    }

    .dnd-list {
        background: #f8f9fa;
        border: 2px dashed #ddd;
        border-radius: 6px;
        padding: 0.5rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .dnd-list.selected-list {
        background: #e3f2fd;
        border-color: #2196f3;
    }

    .dnd-item {
        background: white;
        padding: 0.5rem 0.8rem;
        border-radius: 4px;
        border: 1px solid #ddd;
        cursor: grab;
        user-select: none;
        transition: transform 0.1s, box-shadow 0.1s;
        font-size: 0.9rem;
    }

    .dnd-item:hover {
        background: #fafafa;
        border-color: #ccc;
    }

    .dnd-item:active {
        cursor: grabbing;
    }

    .dnd-item.dragging {
        opacity: 0.5;
        border: 1px dashed #999;
    }

    @media (max-width: 600px) {
        .dnd-container {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    let draggedItem = null;

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        draggedItem = ev.target;
        ev.target.classList.add('dragging');
        ev.dataTransfer.setData("text", ev.target.getAttribute('data-value'));
    }

    // Add dragend listener to cleanup class if drop fails or completes
    document.addEventListener('dragend', function (ev) {
        if (ev.target.classList.contains('dnd-item')) {
            ev.target.classList.remove('dragging');
        }
    });

    function drop(ev) {
        ev.preventDefault();

        // Find the closest dropzone (list)
        let dropZone = ev.target.closest('.dnd-list');
        if (!dropZone) return;

        // If dropping onto an item, insert before that item
        let targetItem = ev.target.closest('.dnd-item');

        if (targetItem && targetItem !== draggedItem) {
            // Determine insertion point (above or below) could be added here
            // distinct visual cue, but simple insertBefore is fine for v1
            dropZone.insertBefore(draggedItem, targetItem);
        } else {
            // Dropped in empty space of list
            dropZone.appendChild(draggedItem);
        }
    }

    function prepareExportForm() {
        const inputsContainer = document.getElementById('formInputs');
        inputsContainer.innerHTML = '';

        const selectedItems = document.querySelectorAll('#selectedFields .dnd-item');
        selectedItems.forEach(item => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'fields';
            input.value = item.getAttribute('data-value');
            inputsContainer.appendChild(input);
        });

        return true;
    }
</script>

{% endblock %}