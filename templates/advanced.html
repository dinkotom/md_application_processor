{% extends "base.html" %}

{% block title %}Pokroƒçil√© - Mlad√Ω div√°k{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Pokroƒçil√© nastaven√≠</h2>
</div>

<!-- Mode Switcher Section -->
<div class="settings-section">
    <h3>Re≈æim datab√°ze</h3>
    <p class="subtitle">P≈ôep√≠n√°n√≠ mezi testovac√≠ a produkƒçn√≠ datab√°z√≠</p>

    <div class="mode-switcher"
        style="display: flex; align-items: center; gap: 15px; background: #f5f5f5; padding: 15px 20px; border-radius: 8px; margin-top: 1rem;">
        <span style="font-weight: bold;">Aktu√°ln√≠ re≈æim:</span>
        {% if current_mode == 'production' %}
        <span class="badge"
            style="background-color: #dc3545; color: white; font-size: 1em; padding: 8px 16px;">PRODUKCE</span>
        <a href="{{ url_for('switch_mode', mode='test') }}" class="btn btn-secondary">P≈ôepnout na TEST</a>
        {% else %}
        <span class="badge"
            style="background-color: #ffc107; color: black; font-size: 1em; padding: 8px 16px;">TEST</span>
        <a href="{{ url_for('switch_mode', mode='production') }}" class="btn btn-secondary">P≈ôepnout na PRODUKCI</a>
        {% endif %}
    </div>

    <div class="info-box"
        style="margin-top: 1rem; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
        <p style="margin: 0;"><strong>‚ÑπÔ∏è Info:</strong></p>
        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
            <li><strong>TEST</strong> - Pou≈æ√≠v√° <code>applications_test.db</code>, vhodn√© pro testov√°n√≠</li>
            <li><strong>PRODUKCE</strong> - Pou≈æ√≠v√° <code>applications.db</code>, pro ostr√© nasazen√≠</li>
        </ul>
    </div>
</div>

<!-- CSV Import Section -->
<div class="settings-section" style="margin-top: 2rem;">
    <h3>Import dat</h3>
    <p class="subtitle">Importovat uchazeƒçe z CSV souboru</p>

    <form id="csvUploadForm" enctype="multipart/form-data" style="margin-top: 1rem;">
        <input type="file" id="csvFileInput" name="csv_file" accept=".csv" style="display: none;"
            onchange="handleCSVUpload(event)">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">
            <span style="margin-right: 0.5rem;">üìÑ</span> Vybrat CSV soubor
        </button>
    </form>

    <div class="info-box"
        style="margin-top: 1rem; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
        <p style="margin: 0;"><strong>‚ö†Ô∏è Form√°t CSV:</strong></p>
        <p style="margin: 0.5rem 0 0 0;">CSV soubor mus√≠ obsahovat sloupce:
            <code>id, jmeno, prijmeni, email, telefon, datum_narozeni, bydliste, skola, oblast_kultury, povaha, intenzita_vyuzivani, zdroje, kde, volne_sdeleni, barvy, souhlas</code>
        </p>
    </div>
</div>

<!-- Database Management Section (Test mode only) -->
{% if current_mode != 'production' %}
<div class="settings-section" style="margin-top: 2rem;">
    <h3>Spr√°va datab√°ze</h3>
    <p class="subtitle">N√°stroje pro spr√°vu testovac√≠ datab√°ze</p>

    <button type="button" class="btn" style="background-color: #dc3545; color: white; margin-top: 1rem;"
        onclick="openClearDbModal()">
        <span style="margin-right: 0.5rem;">üóëÔ∏è</span> Smazat testovac√≠ datab√°zi
    </button>

    <div class="info-box"
        style="margin-top: 1rem; padding: 15px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">
        <p style="margin: 0;"><strong>‚ö†Ô∏è Pozor:</strong> Tato akce je nevratn√° a sma≈æe v≈°echny z√°znamy v testovac√≠
            datab√°zi.</p>
    </div>
</div>
{% endif %}

<!-- Clear DB Confirmation Modal -->
<div id="clearDbModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">‚ö†Ô∏è Smazat datab√°zi?</div>
        <div class="modal-body">
            <p>Opravdu chcete smazat <strong>celou testovac√≠ datab√°zi</strong>?</p>
            <p style="color: #dc3545;">Tato akce je nevratn√° a sma≈æe v≈°echny p≈ôihl√°≈°ky v testovac√≠m re≈æimu.</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeClearDbModal()">Zru≈°it</button>
            <form id="clearDbForm" action="{{ url_for('clear_database') }}" method="POST" style="display: inline;">
                <button type="button" class="btn" style="background-color: #dc3545; color: white;"
                    onclick="submitClearDb()">Ano, smazat v≈°e</button>
            </form>
        </div>
    </div>
</div>

<!-- Import Confirmation Modal -->
<div id="importModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">Potvrzen√≠ importu</div>
        <div class="modal-body">
            <p><span id="importSource">CSV soubor</span> obsahuje <strong id="importTotal">0</strong> z√°znam≈Ø.</p>
            <p>Bude importov√°no: <strong id="importNew" style="color: var(--success-color);">0</strong> nov√Ωch uchazeƒç≈Ø
            </p>
            <p>Bude p≈ôeskoƒçeno: <strong id="importDuplicates" style="color: var(--warning-color);">0</strong> duplicit
            </p>
            <br>
            <p>Chcete pokraƒçovat?</p>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeImportModal()" class="btn btn-secondary">Zru≈°it</button>
            <button type="button" onclick="confirmImport()" class="btn btn-primary">Pokraƒçovat</button>
        </div>
    </div>
</div>

<!-- Email Template Section -->
<div class="settings-section" style="margin-top: 2rem;">
    <h3>üìß ≈†ablona emailu</h3>
    <p class="subtitle">
        Nastavte ≈°ablonu emailu pro odes√≠l√°n√≠ ƒçlensk√Ωch karet uchazeƒç≈Øm.
    </p>

    <div class="info-box"
        style="background: #e3f2fd; border-left: 4px solid #1976d2; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
        <strong>Dostupn√© z√°stupn√© symboly:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem;">
            <li><code>{first_name}</code> - Jm√©no uchazeƒçe</li>
            <li><code>{last_name}</code> - P≈ô√≠jmen√≠ uchazeƒçe</li>
            <li><code>{membership_id}</code> - ƒå√≠slo ƒçlensk√© karty</li>
            <li><code>{email}</code> - Email uchazeƒçe</li>
        </ul>
    </div>

    <form id="emailTemplateForm" style="margin-top: 1.5rem;">
        <div class="form-group">
            <label for="email_subject">P≈ôedmƒõt</label>
            <input type="text" id="email_subject" name="subject" class="form-control" placeholder="P≈ôedmƒõt emailu..."
                required>
        </div>

        <div class="form-group">
            <label for="email_body">Text emailu</label>
            <textarea id="email_body" name="body" class="form-control" rows="10" placeholder="Text emailu..."
                required></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Ulo≈æit ≈°ablonu</button>
        <span id="templateSaveStatus" style="margin-left: 1rem; color: var(--success-color);"></span>
    </form>
</div>

<!-- Changelog Section -->
<div class="settings-section" style="margin-top: 2rem;">
    <h3>üìã Historie zmƒõn</h3>
    <p class="subtitle">
        P≈ôehled zmƒõn a nov√Ωch funkc√≠ v jednotliv√Ωch verz√≠ch
    </p>

    <div
        style="margin-top: 1.5rem; max-height: 600px; overflow-y: auto; background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
        <div id="changelogContent">
            <p>Naƒç√≠t√°n√≠...</p>
        </div>
    </div>
</div>

<script>
    // Load email template on page load
    async function loadEmailTemplate() {
        try {
            const response = await fetch('/email/template');
            const data = await response.json();

            document.getElementById('email_subject').value = data.subject || '';
            document.getElementById('email_body').value = data.body || '';
        } catch (error) {
            console.error('Error loading email template:', error);
        }
    }

    // Save email template
    document.getElementById('emailTemplateForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const statusEl = document.getElementById('templateSaveStatus');

        try {
            const response = await fetch('/email/template', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                statusEl.textContent = '‚úì ≈†ablona √∫spƒõ≈°nƒõ ulo≈æena';
                statusEl.style.color = 'var(--success-color)';

                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
            } else {
                statusEl.textContent = '‚úó Chyba p≈ôi ukl√°d√°n√≠ ≈°ablony';
                statusEl.style.color = 'var(--danger-color)';
            }
        } catch (error) {
            console.error('Error saving template:', error);
            statusEl.textContent = '‚úó Chyba p≈ôi ukl√°d√°n√≠ ≈°ablony';
            statusEl.style.color = 'var(--danger-color)';
        }
    });

    // Load template on page load
    loadEmailTemplate();

    // Load changelog
    async function loadChangelog() {
        try {
            const response = await fetch('/changelog');
            const data = await response.json();
            document.getElementById('changelogContent').innerHTML = data.content;
        } catch (error) {
            console.error('Error loading changelog:', error);
            document.getElementById('changelogContent').innerHTML = '<p style="color: var(--danger-color);">Chyba p≈ôi naƒç√≠t√°n√≠ historie zmƒõn</p>';
        }
    }

    loadChangelog();

    function openClearDbModal() {
        const modal = document.getElementById('clearDbModal');
        modal.style.display = 'flex';
        modal.offsetHeight;
        modal.classList.add('active');
    }

    function closeClearDbModal() {
        const modal = document.getElementById('clearDbModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function submitClearDb() {
        closeClearDbModal();
        document.getElementById('clearDbForm').submit();
    }

    // CSV Import handling
    async function handleCSVUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('csv_file', file);

        try {
            const response = await fetch('{{ url_for("import_preview") }}', {
                method: 'POST',
                body: formData
            });

            const stats = await response.json();

            // Show confirmation modal
            document.getElementById('importSource').textContent = 'CSV soubor';
            document.getElementById('importTotal').textContent = stats.total;
            document.getElementById('importNew').textContent = stats.new;
            document.getElementById('importDuplicates').textContent = stats.duplicates;

            const modal = document.getElementById('importModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('active');
        } catch (error) {
            console.error('Error uploading CSV:', error);
            alert('Chyba p≈ôi nahr√°v√°n√≠ CSV souboru.');
        }

        // Reset file input
        event.target.value = '';
    }

    function closeImportModal() {
        const modal = document.getElementById('importModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function confirmImport() {
        fetch('{{ url_for("import_confirm") }}', {
            method: 'POST'
        }).then(() => {
            window.location.href = '{{ url_for("index") }}';
        });
    }

    // Close modals on click outside
    window.onclick = function (event) {
        const clearModal = document.getElementById('clearDbModal');
        const importModal = document.getElementById('importModal');

        if (event.target == clearModal) {
            closeClearDbModal();
        }
        if (event.target == importModal) {
            closeImportModal();
        }
    }
</script>

<style>
    .settings-section {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .settings-section h3 {
        margin-top: 0;
        color: #333;
    }

    .info-box {
        font-size: 0.9em;
    }

    .info-box code {
        background: rgba(0, 0, 0, 0.05);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
    }
</style>
{% endblock %}