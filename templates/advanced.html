{% extends "base.html" %}

{% block title %}Pokroƒçil√© - Mlad√Ω div√°k{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Pokroƒçil√© nastaven√≠</h2>
</div>

<!-- Mode Switcher Section -->
<div class="settings-section">
    <h3>Re≈æim datab√°ze</h3>
    <p class="subtitle">P≈ôep√≠n√°n√≠ mezi testovac√≠ a produkƒçn√≠ datab√°z√≠</p>

    <div class="mode-switcher"
        style="display: flex; align-items: center; gap: 15px; background: #f5f5f5; padding: 15px 20px; border-radius: 8px; margin-top: 1rem;">
        <span style="font-weight: bold;">Aktu√°ln√≠ re≈æim:</span>
        {% if current_mode == 'production' %}
        <span class="badge"
            style="background-color: #dc3545; color: white; font-size: 1em; padding: 8px 16px;">PRODUKCE</span>
        <a href="{{ url_for('switch_mode', mode='test') }}" class="btn btn-secondary">P≈ôepnout na TEST</a>
        {% else %}
        <span class="badge"
            style="background-color: #ffc107; color: black; font-size: 1em; padding: 8px 16px;">TEST</span>
        <a href="{{ url_for('switch_mode', mode='production') }}" class="btn btn-secondary">P≈ôepnout na PRODUKCI</a>
        {% endif %}
    </div>

    <div class="info-box"
        style="margin-top: 1rem; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
        <p style="margin: 0;"><strong>‚ÑπÔ∏è Info:</strong></p>
        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
            <li><strong>TEST</strong> - Pou≈æ√≠v√° <code>applications_test.db</code>, vhodn√© pro testov√°n√≠</li>
            <li><strong>PRODUKCE</strong> - Pou≈æ√≠v√° <code>applications.db</code>, pro ostr√© nasazen√≠</li>
        </ul>
    </div>
</div>

<!-- CSV Import Section -->
<div class="settings-section" style="margin-top: 2rem;">
    <h3>Import dat</h3>
    <p class="subtitle">Importovat uchazeƒçe z CSV souboru</p>

    <form id="csvUploadForm" enctype="multipart/form-data" style="margin-top: 1rem;">
        <input type="file" id="csvFileInput" name="csv_file" accept=".csv" style="display: none;"
            onchange="handleCSVUpload(event)">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">
            <span style="margin-right: 0.5rem;">üìÑ</span> Vybrat CSV soubor
        </button>
    </form>

    <div class="info-box"
        style="margin-top: 1rem; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
        <p style="margin: 0;"><strong>‚ö†Ô∏è Form√°t CSV:</strong></p>
        <p style="margin: 0.5rem 0 0 0;">CSV soubor mus√≠ obsahovat sloupce:
            <code>id, jmeno, prijmeni, email, telefon, datum_narozeni, bydliste, skola, oblast_kultury, povaha, intenzita_vyuzivani, zdroje, kde, volne_sdeleni, barvy, souhlas</code>
        </p>
    </div>
</div>

<!-- Database Management Section (Test mode only) -->
{% if current_mode != 'production' %}
<div class="settings-section" style="margin-top: 2rem;">
    <h3>Spr√°va datab√°ze</h3>
    <p class="subtitle">N√°stroje pro spr√°vu testovac√≠ datab√°ze</p>

    <button type="button" class="btn" style="background-color: #dc3545; color: white; margin-top: 1rem;"
        onclick="openClearDbModal()">
        <span style="margin-right: 0.5rem;">üóëÔ∏è</span> Smazat testovac√≠ datab√°zi
    </button>

    <div class="info-box"
        style="margin-top: 1rem; padding: 15px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">
        <p style="margin: 0;"><strong>‚ö†Ô∏è Pozor:</strong> Tato akce je nevratn√° a sma≈æe v≈°echny z√°znamy v testovac√≠
            datab√°zi.</p>
    </div>
</div>
{% endif %}

<!-- Clear DB Confirmation Modal -->
<div id="clearDbModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">‚ö†Ô∏è Smazat datab√°zi?</div>
        <div class="modal-body">
            <p>Opravdu chcete smazat <strong>celou testovac√≠ datab√°zi</strong>?</p>
            <p style="color: #dc3545;">Tato akce je nevratn√° a sma≈æe v≈°echny p≈ôihl√°≈°ky v testovac√≠m re≈æimu.</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeClearDbModal()">Zru≈°it</button>
            <form id="clearDbForm" action="{{ url_for('clear_database') }}" method="POST" style="display: inline;">
                <button type="button" class="btn" style="background-color: #dc3545; color: white;"
                    onclick="submitClearDb()">Ano, smazat v≈°e</button>
            </form>
        </div>
    </div>
</div>

<!-- Import Confirmation Modal -->
<div id="importModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">Potvrzen√≠ importu</div>
        <div class="modal-body">
            <p><span id="importSource">CSV soubor</span> obsahuje <strong id="importTotal">0</strong> z√°znam≈Ø.</p>
            <p>Bude importov√°no: <strong id="importNew" style="color: var(--success-color);">0</strong> nov√Ωch uchazeƒç≈Ø
            </p>
            <p>Bude p≈ôeskoƒçeno: <strong id="importDuplicates" style="color: var(--warning-color);">0</strong> duplicit
            </p>
            <br>
            <p>Chcete pokraƒçovat?</p>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeImportModal()" class="btn btn-secondary">Zru≈°it</button>
            <button type="button" onclick="confirmImport()" class="btn btn-primary">Pokraƒçovat</button>
        </div>
    </div>
</div>

<!-- Email Template Section -->
<div class="settings-section" style="margin-top: 2rem;">
    <h3>üìß ≈†ablona emailu</h3>
    <p class="subtitle">
        Nastavte ≈°ablonu emailu pro odes√≠l√°n√≠ ƒçlensk√Ωch karet uchazeƒç≈Øm.
    </p>

    <div class="info-box"
        style="background: #e3f2fd; border-left: 4px solid #1976d2; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
        <strong>Dostupn√© z√°stupn√© symboly:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem;">
            <li><code>{first_name}</code> - Jm√©no uchazeƒçe</li>
            <li><code>{last_name}</code> - P≈ô√≠jmen√≠ uchazeƒçe</li>
            <li><code>{membership_id}</code> - ƒå√≠slo ƒçlensk√© karty</li>
            <li><code>{email}</code> - Email uchazeƒçe</li>
        </ul>
    </div>

    <form id="emailTemplateForm" style="margin-top: 1.5rem;">
        <div class="form-group">
            <label for="email_subject">P≈ôedmƒõt</label>
            <input type="text" id="email_subject" name="subject" class="form-control" placeholder="P≈ôedmƒõt emailu..."
                required>
        </div>

        <div class="form-group">
            <label for="email_body">Text emailu</label>
            <textarea id="email_body" name="body" class="form-control" rows="10" placeholder="Text emailu..."
                required></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Ulo≈æit ≈°ablonu</button>
        <span id="templateSaveStatus" style="margin-left: 1rem; color: var(--success-color);"></span>
    </form>
</div>

<!-- Ecomail Integration Section -->
<div class="settings-section" style="margin-top: 2rem;">
    <h3>üìß Integrace Ecomail</h3>
    <p class="subtitle">
        Spr√°va kontaktn√≠ch seznam≈Ø a vyhled√°v√°n√≠ odbƒõratel≈Ø
    </p>

    {% if ecomail_error %}
    <div
        style="background: rgba(220, 53, 69, 0.1); border-left: 4px solid #dc3545; padding: 1rem; border-radius: 0.25rem; margin-top: 1rem;">
        <strong>‚ö†Ô∏è Chyba:</strong> {{ ecomail_error }}
    </div>
    {% endif %}

    <!-- Subscriber Lookup -->
    <div style="margin-top: 1.5rem; background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
        <h4 style="margin-top: 0;">üîç Vyhled√°v√°n√≠ odbƒõratele</h4>
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <input type="email" id="lookup_email" class="form-control" placeholder="Zadejte email odbƒõratele"
                style="flex: 1;">
            <button class="btn btn-primary" onclick="lookupSubscriber()">Vyhledat</button>
        </div>

        <div id="lookup_result"
            style="display: none; background: white; padding: 1rem; border-radius: 0.25rem; border: 1px solid var(--border-color); margin-top: 1rem;">
            <!-- Results will be populated here -->
        </div>
    </div>

    <!-- Contact Lists -->
    {% if ecomail_lists %}
    <div style="margin-top: 1.5rem; background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
        <h4 style="margin-top: 0;">üìã Kontaktn√≠ seznamy</h4>
        <p style="color: #666; margin-bottom: 1rem;">Nalezeno {{ ecomail_lists|length }} kontaktn√≠ch seznam≈Ø</p>

        <div style="overflow-x: auto;">
            <table class="applicants-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>N√°zev</th>
                        <th>Odbƒõratel√©</th>
                        <th>Stav</th>
                    </tr>
                </thead>
                <tbody>
                    {% for list in ecomail_lists %}
                    <tr>
                        <td><span class="badge">{{ list.id }}</span></td>
                        <td><strong>{{ list.name }}</strong></td>
                        <td>{{ list.active_subscribers if list.active_subscribers is defined else 'N/A' }}</td>
                        <td>
                            {% if list.status == 'active' or not list.status %}
                            <span style="color: var(--success-color);">‚óè Aktivn√≠</span>
                            {% else %}
                            <span style="color: #999;">‚óã {{ list.status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="openCreateListModal()">
            <span style="margin-right: 0.5rem;">‚ûï</span> Vytvo≈ôit nov√Ω seznam
        </button>
        <button class="btn btn-secondary" onclick="refreshEcomailLists()">
            <span style="margin-right: 0.5rem;">üîÑ</span> Obnovit seznamy
        </button>
    </div>
</div>

<!-- Create List Modal -->
<div id="createListModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">Vytvo≈ôit nov√Ω kontaktn√≠ seznam</div>
        <div class="modal-body">
            <div class="form-group">
                <label for="new_list_name">N√°zev seznamu *</label>
                <input type="text" id="new_list_name" class="form-control" placeholder="nap≈ô. Newsletter 2025" required>
            </div>
            <div class="form-group">
                <label for="new_list_from_name">Jm√©no odes√≠latele *</label>
                <input type="text" id="new_list_from_name" class="form-control" placeholder="nap≈ô. Mlad√Ω div√°k"
                    required>
            </div>
            <div class="form-group">
                <label for="new_list_from_email">Email odes√≠latele *</label>
                <input type="email" id="new_list_from_email" class="form-control" placeholder="nap≈ô. info@mladydivak.cz"
                    required>
            </div>
            <div class="form-group">
                <label for="new_list_reply_to">Reply-To Email *</label>
                <input type="email" id="new_list_reply_to" class="form-control" placeholder="nap≈ô. info@mladydivak.cz"
                    required>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeCreateListModal()">Zru≈°it</button>
            <button class="btn btn-primary" onclick="createEcomailList()">Vytvo≈ôit</button>
        </div>
    </div>
</div>

<!-- Changelog Section -->
<div class="settings-section" style="margin-top: 2rem;">
    <h3>üìã Historie zmƒõn</h3>
    <p class="subtitle">
        P≈ôehled zmƒõn a nov√Ωch funkc√≠ v jednotliv√Ωch verz√≠ch
    </p>

    <div
        style="margin-top: 1.5rem; max-height: 600px; overflow-y: auto; background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
        <div id="changelogContent">
            <p>Naƒç√≠t√°n√≠...</p>
        </div>
    </div>
</div>

<script>
    // Load email template on page load
    async function loadEmailTemplate() {
        try {
            const response = await fetch('/email/template');
            const data = await response.json();

            document.getElementById('email_subject').value = data.subject || '';
            document.getElementById('email_body').value = data.body || '';
        } catch (error) {
            console.error('Error loading email template:', error);
        }
    }

    // Save email template
    document.getElementById('emailTemplateForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const statusEl = document.getElementById('templateSaveStatus');

        try {
            const response = await fetch('/email/template', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                statusEl.textContent = '‚úì ≈†ablona √∫spƒõ≈°nƒõ ulo≈æena';
                statusEl.style.color = 'var(--success-color)';

                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
            } else {
                statusEl.textContent = '‚úó Chyba p≈ôi ukl√°d√°n√≠ ≈°ablony';
                statusEl.style.color = 'var(--danger-color)';
            }
        } catch (error) {
            console.error('Error saving template:', error);
            statusEl.textContent = '‚úó Chyba p≈ôi ukl√°d√°n√≠ ≈°ablony';
            statusEl.style.color = 'var(--danger-color)';
        }
    });

    // Load template on page load
    loadEmailTemplate();

    // Load changelog
    async function loadChangelog() {
        try {
            const response = await fetch('/changelog');
            const data = await response.json();
            document.getElementById('changelogContent').innerHTML = data.content;
        } catch (error) {
            console.error('Error loading changelog:', error);
            document.getElementById('changelogContent').innerHTML = '<p style="color: var(--danger-color);">Chyba p≈ôi naƒç√≠t√°n√≠ historie zmƒõn</p>';
        }
    }

    loadChangelog();

    function openClearDbModal() {
        const modal = document.getElementById('clearDbModal');
        modal.style.display = 'flex';
        modal.offsetHeight;
        modal.classList.add('active');
    }

    function closeClearDbModal() {
        const modal = document.getElementById('clearDbModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function submitClearDb() {
        closeClearDbModal();
        document.getElementById('clearDbForm').submit();
    }

    // CSV Import handling
    async function handleCSVUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('csv_file', file);

        try {
            const response = await fetch('{{ url_for("import_preview") }}', {
                method: 'POST',
                body: formData
            });

            const stats = await response.json();

            // Show confirmation modal
            document.getElementById('importSource').textContent = 'CSV soubor';
            document.getElementById('importTotal').textContent = stats.total;
            document.getElementById('importNew').textContent = stats.new;
            document.getElementById('importDuplicates').textContent = stats.duplicates;

            const modal = document.getElementById('importModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('active');
        } catch (error) {
            console.error('Error uploading CSV:', error);
            alert('Chyba p≈ôi nahr√°v√°n√≠ CSV souboru.');
        }

        // Reset file input
        event.target.value = '';
    }

    function closeImportModal() {
        const modal = document.getElementById('importModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function confirmImport() {
        fetch('{{ url_for("import_confirm") }}', {
            method: 'POST'
        }).then(() => {
            window.location.href = '{{ url_for("index") }}';
        });
    }

    // Close modals on click outside
    window.onclick = function (event) {
        const clearModal = document.getElementById('clearDbModal');
        const importModal = document.getElementById('importModal');

        if (event.target == clearModal) {
            closeClearDbModal();
        }
        if (event.target == importModal) {
            closeImportModal();
        }
    }

    // Ecomail functions
    function refreshEcomailLists() {
        window.location.reload();
    }

    function openCreateListModal() {
        const modal = document.getElementById('createListModal');
        modal.style.display = 'flex';
        modal.offsetHeight;
        modal.classList.add('active');
        document.getElementById('new_list_name').focus();
    }

    function closeCreateListModal() {
        const modal = document.getElementById('createListModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            document.getElementById('new_list_name').value = '';
            document.getElementById('new_list_from_name').value = '';
            document.getElementById('new_list_from_email').value = '';
            document.getElementById('new_list_reply_to').value = '';
        }, 300);
    }

    async function createEcomailList() {
        const name = document.getElementById('new_list_name').value;
        const fromName = document.getElementById('new_list_from_name').value;
        const fromEmail = document.getElementById('new_list_from_email').value;
        const replyTo = document.getElementById('new_list_reply_to').value;

        if (!name || !fromName || !fromEmail || !replyTo) {
            alert('Pros√≠m vypl≈àte v≈°echna povinn√° pole');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('name', name);
            formData.append('from_name', fromName);
            formData.append('from_email', fromEmail);
            formData.append('reply_to', replyTo);

            const response = await fetch('/ecomail/create_list', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                closeCreateListModal();
                window.location.reload();
            } else {
                alert('Chyba p≈ôi vytv√°≈ôen√≠ seznamu: ' + (result.error || 'Nezn√°m√° chyba'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Chyba p≈ôi vytv√°≈ôen√≠ seznamu');
        }
    }

    async function lookupSubscriber() {
        const email = document.getElementById('lookup_email').value;
        const resultContainer = document.getElementById('lookup_result');

        if (!email) {
            alert('Pros√≠m zadejte emailovou adresu');
            return;
        }

        resultContainer.style.display = 'block';
        resultContainer.innerHTML = '<p>Vyhled√°v√°n√≠...</p>';

        try {
            const formData = new FormData();
            formData.append('email', email);

            const response = await fetch('/ecomail/subscriber', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                const sub = result.data.subscriber;
                let html = `
                    <h4 style="margin-top: 0;">${sub.email}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Jm√©no:</strong> ${sub.name || '-'} ${sub.surname || ''}<br>
                            <strong>Telefon:</strong> ${sub.phone || '-'}<br>
                            <strong>Mƒõsto:</strong> ${sub.city || '-'}<br>
                            <strong>Datum narozen√≠:</strong> ${sub.birthday || '-'}<br>
                        </div>
                        <div>
                            <strong>Sk√≥re:</strong> ${sub.score || 0}<br>
                            <strong>Stav:</strong> ${sub.status || '-'}<br>
                            <strong>Vytvo≈ôeno:</strong> ${sub.created_at || '-'}<br>
                            <strong>Bounced:</strong> ${sub.bounced ? 'Ano' : 'Ne'}<br>
                        </div>
                    </div>
                `;

                // Custom fields
                if (sub.custom_fields) {
                    html += '<h5 style="margin-bottom: 0.5rem; margin-top: 1rem;">Vlastn√≠ pole</h5><ul style="margin-top: 0; padding-left: 1.5rem;">';
                    for (const [key, value] of Object.entries(sub.custom_fields)) {
                        if (value) {
                            html += `<li><strong>${key}:</strong> ${value}</li>`;
                        }
                    }
                    html += '</ul>';
                }

                // Lists
                if (sub.lists && sub.lists.length > 0) {
                    html += '<h5 style="margin-bottom: 0.5rem; margin-top: 1rem;">Odeb√≠ran√© seznamy</h5><ul style="margin-top: 0; padding-left: 1.5rem;">';
                    sub.lists.forEach(list => {
                        html += `<li>ID: ${list.list_id} (Stav: ${list.status})</li>`;
                    });
                    html += '</ul>';
                }

                resultContainer.innerHTML = html;
            } else {
                resultContainer.innerHTML = `<p style="color: var(--danger-color);">Chyba: ${result.error}</p>`;
            }
        } catch (error) {
            console.error('Error:', error);
            resultContainer.innerHTML = '<p style="color: var(--danger-color);">Chyba p≈ôi p≈ôipojen√≠ k serveru</p>';
        }
    }

    // Close Ecomail modal on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeCreateListModal();
        }
    });
</script>

<style>
    .settings-section {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .settings-section h3 {
        margin-top: 0;
        color: #333;
    }

    .info-box {
        font-size: 0.9em;
    }

    .info-box code {
        background: rgba(0, 0, 0, 0.05);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
    }
</style>
{% endblock %}