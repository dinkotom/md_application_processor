{% extends "base.html" %}

{% block title %}P≈ôihl√°≈°ky - Mlad√Ω div√°k{% endblock %}

{% block content %}
<div class="page-header">
    <h2>P≈ôihl√°≈°ky uchazeƒç≈Ø</h2>

    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
        <p class="subtitle" style="margin: 0;">Celkem: <strong>{{ total }}</strong> z√°znam≈Ø</p>
        <button type="button" class="btn btn-primary" onclick="handleEmailFetch(this)">
            <span style="margin-right: 0.5rem;">‚¨áÔ∏è</span> St√°hnout nov√© p≈ôihl√°≈°ky
        </button>
    </div>
</div>



<div class="filters-container">
    <form action="{{ url_for('applicants.index') }}" method="GET" class="search-form">
        <input type="text" name="search" class="search-input" placeholder="Hledat jm√©no, email, mƒõsto..."
            value="{{ search }}">
        <button type="submit" class="btn btn-primary">Hledat</button>
    </form>

    <!-- Status and Alert Filter Buttons -->
    <div
        style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <!-- Status Filter Buttons (Left) -->
        <div class="status-filter-buttons">
            <a href="{{ url_for('applicants.index', status='Nov√°', search=search, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts) }}"
                class="status-filter-btn status-nova {% if filter_status == 'Nov√°' %}active{% endif %}">
                Nov√°
            </a>
            <a href="{{ url_for('applicants.index', status='Zpracov√°v√° se', search=search, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts) }}"
                class="status-filter-btn status-zpracovava-se {% if filter_status == 'Zpracov√°v√° se' %}active{% endif %}">
                Zpracov√°v√° se
            </a>
            <a href="{{ url_for('applicants.index', status='Vy≈ô√≠zen√°', search=search, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts) }}"
                class="status-filter-btn status-vyrizena {% if filter_status == 'Vy≈ô√≠zen√°' %}active{% endif %}">
                Vy≈ô√≠zen√°
            </a>
            {% if filter_status %}
            <a href="{{ url_for('applicants.index', search=search, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts) }}"
                class="status-filter-btn" style="margin-left: 0.5rem;">
                ‚úï Zru≈°it
            </a>
            {% endif %}
        </div>

        {% if total_pages >= 1 %}
        <div class="pagination"
            style="margin: 0; padding: 0; border: none; background: transparent; justify-content: center;">
            <!-- First Page -->
            {% if page > 1 %}
            <a href="{{ url_for('applicants.index', page=1, search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts, character=filter_character) }}"
                class="btn btn-secondary" title="Prvn√≠ str√°nka" style="padding: 0.25rem 0.6rem; font-size: 0.9em;">
                &laquo;&laquo;
            </a>
            <a href="{{ url_for('applicants.index', page=page-1, search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts, character=filter_character) }}"
                class="btn btn-secondary" title="P≈ôedchoz√≠ str√°nka" style="padding: 0.25rem 0.6rem; font-size: 0.9em;">
                &laquo;
            </a>
            {% else %}
            <span class="btn btn-secondary disabled"
                style="padding: 0.25rem 0.6rem; font-size: 0.9em; opacity: 0.5;">&laquo;&laquo;</span>
            <span class="btn btn-secondary disabled"
                style="padding: 0.25rem 0.6rem; font-size: 0.9em; opacity: 0.5;">&laquo;</span>
            {% endif %}

            <!-- Page Info -->
            <span
                style="font-size: 0.9em; color: #666; font-weight: 500; margin: 0 0.5rem; background: #fff; padding: 0.25rem 0.75rem; border-radius: 4px; border: 1px solid #ddd;">
                {{ page }} / {{ total_pages }}
            </span>

            <!-- Next/Last Page -->
            {% if page < total_pages %} <a
                href="{{ url_for('applicants.index', page=page+1, search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts, character=filter_character) }}"
                class="btn btn-secondary" title="Dal≈°√≠ str√°nka" style="padding: 0.25rem 0.6rem; font-size: 0.9em;">
                &raquo;
                </a>
                <a href="{{ url_for('applicants.index', page=total_pages, search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts, character=filter_character) }}"
                    class="btn btn-secondary" title="Posledn√≠ str√°nka"
                    style="padding: 0.25rem 0.6rem; font-size: 0.9em;">
                    &raquo;&raquo;
                </a>
                {% else %}
                <span class="btn btn-secondary disabled"
                    style="padding: 0.25rem 0.6rem; font-size: 0.9em; opacity: 0.5;">&raquo;</span>
                <span class="btn btn-secondary disabled"
                    style="padding: 0.25rem 0.6rem; font-size: 0.9em; opacity: 0.5;">&raquo;&raquo;</span>
                {% endif %}
        </div>
        {% endif %}

        <!-- Alert Filter Button (Right) -->
        <div>
            <a href="{{ url_for('applicants.index', alerts='true', search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source) }}"
                class="status-filter-btn {% if filter_alerts == 'true' %}active{% endif %}"
                style="background: #ff9800; border-color: #ff9800;">
                ‚ö†Ô∏è Pouze s upozornƒõn√≠mi
            </a>
            {% if filter_alerts == 'true' %}
            <a href="{{ url_for('applicants.index', search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source) }}"
                class="status-filter-btn" style="margin-left: 0.5rem;">
                ‚úï Zru≈°it
            </a>
            {% endif %}
        </div>
    </div>

    {% if filter_age_group or filter_city or filter_school or filter_interest or filter_source %}
    <div class="active-filters">
        <span class="filter-label">Aktivn√≠ filtry:</span>
        {% if filter_age_group %}
        <span class="filter-tag">Vƒõk: {{ filter_age_group }} <a
                href="{{ url_for('applicants.index', search=search, status=filter_status, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source) }}"
                class="remove-filter">&times;</a></span>
        {% endif %}
        {% if filter_city %}
        <span class="filter-tag">Mƒõsto: {{ filter_city }} <a
                href="{{ url_for('applicants.index', search=search, status=filter_status, age_group=filter_age_group, school=filter_school, interest=filter_interest, source=filter_source) }}"
                class="remove-filter">&times;</a></span>
        {% endif %}
        {% if filter_school %}
        <span class="filter-tag">≈†kola: {{ filter_school }} <a
                href="{{ url_for('applicants.index', search=search, status=filter_status, age_group=filter_age_group, city=filter_city, interest=filter_interest, source=filter_source) }}"
                class="remove-filter">&times;</a></span>
        {% endif %}
        {% if filter_interest %}
        <span class="filter-tag">Z√°jem: {{ filter_interest }} <a
                href="{{ url_for('applicants.index', search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, source=filter_source) }}"
                class="remove-filter">&times;</a></span>
        {% endif %}
        {% if filter_source %}
        <span class="filter-tag">Zdroj: {{ filter_source }} <a
                href="{{ url_for('applicants.index', search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest) }}"
                class="remove-filter">&times;</a></span>
        {% endif %}
        <a href="{{ url_for('applicants.index') }}" class="clear-all-filters">Zru≈°it v≈°e</a>
    </div>
    {% endif %}
</div>

<!-- Pagination (Top) -->


<div class="table-container">
    <table class="applicants-table">
        <thead>
            <tr>
                <th>
                    <a href="{{ url_for('applicants.index', sort='id', order='asc' if (request.args.get('sort') == 'id' and request.args.get('order') == 'desc') else 'desc', search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source) }}"
                        style="color: inherit; text-decoration: none; white-space: nowrap;">
                        ID {% if request.args.get('sort') == 'id' %}{{ '‚ñ≤' if request.args.get('order') == 'asc' else
                        '‚ñº' }}{% else %}‚Üï{% endif %}
                    </a>
                </th>
                <th>Jm√©no</th>
                <th>Email</th>
                <th>Telefon</th>
                <th>Vƒõk</th>
                <th>Mƒõsto</th>
                <th>
                    <a href="{{ url_for('applicants.index', sort='application_received', order='asc' if (request.args.get('sort') == 'application_received' and request.args.get('order') == 'desc') else 'desc', search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source) }}"
                        style="color: inherit; text-decoration: none; white-space: nowrap;">
                        P≈ôihl√°≈°ka {% if request.args.get('sort') == 'application_received' %}{{ '‚ñ≤' if
                        request.args.get('order') == 'asc' else '‚ñº' }}{% else %}‚Üï{% endif %}
                    </a>
                </th>
                <th>Stav</th>
                <th style="text-align: center;">üìù</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
            {% for app in applicants %}
            <tr class="{% if app.age is none or (app.age and (app.age < 15 or app.age >= 25)) or app.suspect_parent_email or app.is_duplicate %}warning-row{% endif %}"
                style="cursor: pointer;"
                onclick="window.location='{{ url_for('applicants.detail', id=app.id, **request.args) }}'">
                <td><span class="badge">{{ app.membership_id }}</span></td>
                <td><strong>{{ app.first_name }} {{ app.last_name }}</strong></td>
                <td onclick="event.stopPropagation()"><a href="mailto:{{ app.email }}">{{ app.email }}</a></td>
                <td>{{ app.phone or '-' }}</td>
                <td>
                    {% if app.age is not none %}
                    {{ app.age }} let
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>{{ app.city or '-' }}</td>
                <td>
                    {% if app.application_received %}
                    {{ app.application_received[:16] }}
                    {% else %}
                    <span style="color: #999;">-</span>
                    {% endif %}
                </td>
                <td onclick="event.stopPropagation()">
                    <form action="{{ url_for('applicants.update_applicant_status', id=app.id) }}" method="POST"
                        style="margin: 0;">
                        <input type="hidden" name="next" value="{{ url_for('applicants.index', **request.args) }}">
                        <select name="status" onchange="this.form.submit()"
                            class="status-select status-{{ app.status | slugify_status }}"
                            style="border: none; padding: 5px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 500; cursor: pointer; appearance: none; -webkit-appearance: none; text-align: center;">
                            <option value="Nov√°" {% if app.status=='Nov√°' %}selected{% endif %}>Nov√°</option>
                            <option value="Zpracov√°v√° se" {% if app.status=='Zpracov√°v√° se' %}selected{% endif %}>
                                Zpracov√°v√° se</option>
                            <option value="Vy≈ô√≠zen√°" {% if app.status=='Vy≈ô√≠zen√°' %}selected{% endif %}>Vy≈ô√≠zen√°
                            </option>
                        </select>
                    </form>
                </td>
                <td onclick="event.stopPropagation()" style="text-align: center;">
                    <button onclick='openNoteModal({{ app.id }}, {{ app.note | tojson if app.note else "null" }})'
                        style="border: none; background: none; cursor: pointer; padding: 0.25rem;"
                        title="{% if app.note %}Zobrazit/upravit pozn√°mku{% else %}P≈ôidat pozn√°mku{% endif %}">
                        <svg width="16" height="16" viewBox="0 0 24 24"
                            fill="{% if app.note %}#36378c{% else %}#ccc{% endif %}" stroke="currentColor"
                            stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                    </button>
                </td>
                <td onclick="event.stopPropagation()">
                    <a href="{{ url_for('applicants.detail', id=app.id, **request.args) }}"
                        class="btn btn-small btn-secondary">Detail</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="10" class="text-center">≈Ω√°dn√© z√°znamy nenalezeny</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="pagination">
    <!-- First Page -->
    {% if page > 1 %}
    <a href="{{ url_for('applicants.index', page=1, search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts, character=filter_character) }}"
        class="btn btn-secondary" title="Prvn√≠ str√°nka">
        &laquo;&laquo;
    </a>
    <a href="{{ url_for('applicants.index', page=page-1, search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts, character=filter_character) }}"
        class="btn btn-secondary" title="P≈ôedchoz√≠ str√°nka">
        &laquo;
    </a>
    {% else %}
    <span class="btn btn-secondary disabled">&laquo;&laquo;</span>
    <span class="btn btn-secondary disabled">&laquo;</span>
    {% endif %}

    <!-- Page Numbers -->
    <div class="pagination-numbers">
        {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <span class="page-number active">{{ p }}</span>
        {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %} <a
            href="{{ url_for('applicants.index', page=p, search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts, character=filter_character) }}"
            class="page-number">{{ p }}</a>
            {% elif p == page - 3 or p == page + 3 %}
            <span class="page-ellipsis">...</span>
            {% endif %}
            {% endfor %}
    </div>

    <!-- Next/Last Page -->
    {% if page < total_pages %} <a
        href="{{ url_for('applicants.index', page=page+1, search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts, character=filter_character) }}"
        class="btn btn-secondary" title="Dal≈°√≠ str√°nka">
        &raquo;
        </a>
        <a href="{{ url_for('applicants.index', page=total_pages, search=search, status=filter_status, age_group=filter_age_group, city=filter_city, school=filter_school, interest=filter_interest, source=filter_source, alerts=filter_alerts, character=filter_character) }}"
            class="btn btn-secondary" title="Posledn√≠ str√°nka">
            &raquo;&raquo;
        </a>
        {% else %}
        <span class="btn btn-secondary disabled">&raquo;</span>
        <span class="btn btn-secondary disabled">&raquo;&raquo;</span>
        {% endif %}
</div>
{% endif %}

<!-- Edit Modal -->
<div id="editModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">Upravit uchazeƒçe</div>
        <form id="editForm" method="POST">
            <div class="form-group">
                <label for="edit_first_name">Jm√©no</label>
                <input type="text" id="edit_first_name" name="first_name" required class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_last_name">P≈ô√≠jmen√≠</label>
                <input type="text" id="edit_last_name" name="last_name" required class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_email">Email</label>
                <input type="email" id="edit_email" name="email" required class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_phone">Telefon</label>
                <input type="text" id="edit_phone" name="phone" class="form-control">
            </div>
            <div class="form-group">
                <label for="edit_dob">Datum narozen√≠</label>
                <input type="text" id="edit_dob" name="dob" placeholder="DD.MM.YYYY" class="form-control">
            </div>

            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border-color);">

            <div class="form-group">
                <label for="edit_status">Stav p≈ôihl√°≈°ky</label>
                <select id="edit_status" class="form-control" onchange="updateStatus(this.value)">
                    <option value="Nov√°">Nov√°</option>
                    <option value="Zpracov√°v√° se">Zpracov√°v√° se</option>
                    <option value="Vy≈ô√≠zen√°">Vy≈ô√≠zen√°</option>
                </select>
                <input type="hidden" id="status_input" name="status">
            </div>

            <div class="modal-actions" style="margin-top: 1.5rem;">
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Zru≈°it</button>
                <button type="submit" class="btn btn-primary">Ulo≈æit zmƒõny</button>
            </div>
        </form>
    </div>
</div>

<!-- Import Confirmation Modal -->
<div id="importModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">Potvrzen√≠ importu</div>
        <div class="modal-body">
            <p><span id="importSource">Import</span> obsahuje <strong id="importTotal">0</strong> z√°znam≈Ø.</p>
            <p>Bude importov√°no: <strong id="importNew" style="color: var(--success-color);">0</strong> nov√Ωch uchazeƒç≈Ø
            </p>
            <p>Bude p≈ôeskoƒçeno: <strong id="importDuplicates" style="color: var(--warning-color);">0</strong> duplicit
            </p>
            <br>
            <p>Chcete pokraƒçovat?</p>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeImportModal()" class="btn btn-secondary">Zru≈°it</button>
            <button type="button" onclick="confirmImport()" class="btn btn-primary">Pokraƒçovat</button>
        </div>
    </div>
</div>

<script>
    let currentApplicantId = null;

    function openEditModal(event, id, firstName, lastName, email, phone, dob, status) {
        event.stopPropagation(); // Prevent row click
        currentApplicantId = id;

        const modal = document.getElementById('editModal');
        const form = document.getElementById('editForm');

        // Set form action
        form.action = `/applicant/${id}/update`;

        // Populate fields
        document.getElementById('edit_first_name').value = firstName;
        document.getElementById('edit_last_name').value = lastName;
        document.getElementById('edit_email').value = email;
        document.getElementById('edit_phone').value = phone;
        document.getElementById('edit_dob').value = dob;

        // Set status
        const statusSelect = document.getElementById('edit_status');
        statusSelect.value = status;
        document.getElementById('status_input').value = status; // Sync hidden input

        modal.style.display = 'flex';
        // Trigger reflow
        modal.offsetHeight;
        modal.classList.add('active');
    }

    function updateStatus(newStatus) {
        document.getElementById('status_input').value = newStatus;
    }

    function closeEditModal() {
        const modal = document.getElementById('editModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    // Close on click outside
    document.getElementById('editModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeEditModal();
        }
    });

    // Close on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeEditModal();
        }
    });

    // Track current import type ('csv' or 'email')
    let currentImportType = null;

    // Email Import handling
    async function handleEmailFetch(btn) {
        // Save original state
        const originalText = btn.innerHTML;

        // Set loading state
        btn.disabled = true;
        btn.innerHTML = '<span style="margin-right: 0.5rem;">‚è≥</span> Stahov√°n√≠...';

        try {
            const response = await fetch('{{ url_for("applicants.fetch_preview") }}', {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                Swal.fire('Chyba', 'Chyba p≈ôi stahov√°n√≠ email≈Ø: ' + (error.error || 'Nezn√°m√° chyba'), 'error');
                return;
            }

            const stats = await response.json();

            // Set import type
            currentImportType = 'email';

            // Show confirmation modal
            document.getElementById('importSource').textContent = 'Emailov√° schr√°nka';
            document.getElementById('importTotal').textContent = stats.total;
            document.getElementById('importNew').textContent = stats.new;
            document.getElementById('importDuplicates').textContent = stats.duplicates;

            const modal = document.getElementById('importModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('active');
        } catch (error) {
            console.error('Error fetching emails:', error);
            Swal.fire('Chyba', 'Chyba p≈ôi stahov√°n√≠ email≈Ø.', 'error');
        } finally {
            // Restore original state
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }



    function closeImportModal() {
        const modal = document.getElementById('importModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function confirmImport() {
        // Disable buttons to prevent double-click
        const confirmBtn = document.querySelector('#importModal .btn-primary');
        const cancelBtn = document.querySelector('#importModal .btn-secondary');

        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span style="margin-right: 0.5rem;">‚è≥</span> Pracuji...';
        }
        if (cancelBtn) {
            cancelBtn.disabled = true;
        }

        // Determine which endpoint to call based on import type
        const endpoint = currentImportType === 'email'
            ? '{{ url_for("applicants.fetch_confirm") }}'
            : '{{ url_for("settings.import_confirm") }}';

        // Submit to confirm endpoint
        fetch(endpoint, {
            method: 'POST'
        }).then(response => response.json())
            .then(data => {
                if (data.errors && data.errors.length > 0) {
                    Swal.fire('Info', 'Import dokonƒçen s chybami:\n' + data.errors.join('\n'), 'warning');
                }
                window.location.reload();
            }).catch(error => {
                console.error('Error confirming import:', error);
                Swal.fire('Chyba', 'Chyba p≈ôi importu: ' + error, 'error');
                // Re-enable buttons on error
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = 'Pokraƒçovat';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                }
            });
    }

    // Close import modal on click outside
    document.getElementById('importModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeImportModal();
        }
    });
</script>

<!-- Note Modal -->
<div id="noteModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-title">Pozn√°mka</div>
        <div class="modal-body">
            <textarea id="noteText" rows="5"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-family: inherit; resize: vertical;"></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeNoteModal()">Zru≈°it</button>
            <button class="btn btn-primary" onclick="saveNote()">Ulo≈æit</button>
        </div>
    </div>
</div>

<script>
    let currentNoteApplicantId = null;

    function openNoteModal(applicantId, currentNote) {
        currentNoteApplicantId = applicantId;
        document.getElementById('noteText').value = currentNote || '';

        const modal = document.getElementById('noteModal');
        modal.style.display = 'flex';
        modal.offsetHeight;
        modal.classList.add('active');

        document.getElementById('noteText').focus();
    }

    function closeNoteModal() {
        const modal = document.getElementById('noteModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            currentNoteApplicantId = null;
        }, 300);
    }

    async function saveNote() {
        if (!currentNoteApplicantId) return;

        const noteText = document.getElementById('noteText').value;

        try {
            const formData = new FormData();
            formData.append('note', noteText);

            const response = await fetch(`/applicant/${currentNoteApplicantId}/update_field`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    field: 'note',
                    value: noteText
                })
            });

            const result = await response.json();

            if (result.success) {
                closeNoteModal();
                window.location.reload();
            } else {
                Swal.fire('Chyba', `Chyba: ${result.error}`, 'error');
            }
        } catch (error) {
            console.error('Error saving note:', error);
            Swal.fire('Chyba', 'Chyba p≈ôi ukl√°d√°n√≠ pozn√°mky', 'error');
        }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeNoteModal();
        }
    });

    // Close modal on click outside
    window.addEventListener('click', function (event) {
        if (event.target.id === 'noteModal') {
            closeNoteModal();
        }
    });
</script>

{% endblock %}